generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["relationJoins"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// INDEX OPTIMIZATION (Feb 19, 2026)
// =============================================================================
//
// PostgreSQL B-tree indexes support prefix scans: a composite index @@index([X, Y])
// can serve queries filtering only on X — a standalone @@index([X]) is redundant.
// This schema has been audited to remove ~38 such redundant single-column indexes
// where a composite index with the same leading column already exists.
//
// Similarly, @@unique([X, Y]) constraints create an implicit unique index that
// covers single-column lookups on X, making a standalone @@index([X]) redundant.
//
// DO NOT re-add single-column indexes without verifying no composite/unique index
// with the same leading column exists. When adding a new composite index, check
// whether it makes an existing single-column index redundant.
//
// =============================================================================
// SCHEMA DOCUMENTATION NOTES (Feb 17, 2026)
// =============================================================================
//
// 1. BRANDING DUPLICATION (Organization vs Brand):
//    Organization stores org-wide branding defaults (logo, brandColor, accentColor, favicon).
//    Brand stores team-specific overrides (logo, brandColor, accentColor, banner, welcomeMessage).
//    This is intentional per the settings inheritance pattern. See Brand model and Organization
//    model comments for details.
//
// 2. DEPRECATED FIELD — Investor.address:
//    Single-line address field replaced by structured fields (addressLine1, city, state, etc.).
//    Retained for backward compatibility. Do NOT write to it. Phase 2 migration will remove it.
//
// 3. createdBy NAMING INCONSISTENCY:
//    Two patterns coexist across the schema:
//    - BEST PRACTICE: `createdById String` + `createdBy User @relation(...)` — used by LPDocument,
//      SignatureDocument, Deal, DealDocument, DocumentAnnotation. Provides FK constraint + type safety.
//    - LEGACY: `createdBy String?` (plain string, no FK) — used by Tag, Fund, Investor.approvedBy,
//      Transaction.confirmedBy/initiatedBy, AccessRequest.reviewedBy, ProfileChangeRequest, etc.
//    - PARTIAL: `createdById String?` (correct name, no @relation) — used by SignatureTemplate,
//      ReportTemplate, GeneratedReport.
//    Phase 2: Migrate all legacy fields to the best-practice pattern. Each affected field is
//    annotated with a "NAMING INCONSISTENCY" comment in-line.
// =============================================================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String      @id @default(cuid())
  sessionToken String      @unique
  userId       String
  expires      DateTime
  loginPortal  LoginPortal @default(VISITOR)
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId]) // Performance optimization for user session lookups
  @@index([expires]) // Performance optimization for session cleanup
}

enum LoginPortal {
  ADMIN
  VISITOR
}

model PendingPortalUpdate {
  id        String      @id @default(cuid())
  userId    String
  portal    LoginPortal
  createdAt DateTime    @default(now())
  expiresAt DateTime

  @@index([userId])
  @@index([expiresAt])
}

model User {
  id             String     @id @default(cuid())
  name           String?
  email          String?    @unique
  emailVerified  DateTime?
  password       String? // Bcrypt-hashed password for credentials login
  image          String?
  role           UserRole   @default(LP)
  createdAt      DateTime   @default(now())
  accounts       Account[]
  sessions       Session[]
  documents      Document[]
  teams          UserTeam[]
  domains        Domain[]
  chats          Chat[]
  contactId      String?
  plan           String     @default("free")
  stripeId       String?    @unique // Stripe subscription / customer ID
  subscriptionId String?    @unique // Stripe subscription ID
  startsAt       DateTime? // Stripe subscription start date
  endsAt         DateTime? // Stripe subscription end date

  restrictedTokens RestrictedToken[]

  // conversation
  participatedConversations ConversationParticipant[]
  messages                  Message[]

  // FAQ system
  publishedFaqItems  DataroomFaqItem[]
  createdAnnotations DocumentAnnotation[] // Annotations created by this user

  installedIntegrations InstalledIntegration[]

  // LP Portal - Investor profile
  investorProfile Investor?

  // Audit logs
  auditLogs AuditLog[]

  // Signature documents created by this user
  createdSignatureDocuments SignatureDocument[] @relation("SignatureDocumentOwner")

  // Standalone envelopes created by this user
  envelopesCreated Envelope[] @relation("EnvelopeCreator")

  // Push Notifications
  pushSubscriptions       PushSubscription[]
  notificationPreferences NotificationPreference?
  notifications           Notification[]

  // LP Document Upload relations
  lpDocumentsUploaded LPDocument[]       @relation("LPDocumentUploader")
  lpDocumentsReviewed LPDocument[]       @relation("LPDocumentReviewer")
  lpDocumentReviews   LPDocumentReview[]

  // Marketplace relations
  createdDeals     Deal[]
  dealStageChanges DealStageHistory[]
  dealInterests    DealInterest[]
  dealAllocations  DealAllocation[]
  dealDocuments    DealDocument[]
  dealActivities   DealActivity[]
  dealNotes        DealNote[]

  // Marketplace waitlist conversions
  marketplaceWaitlistConversions MarketplaceWaitlist[] @relation("MarketplaceWaitlistConversions")

  // MFA (Multi-Factor Authentication)
  mfaSecret        String? // AES-256 encrypted TOTP secret
  mfaEnabled       Boolean   @default(false)
  mfaVerifiedAt    DateTime?
  mfaRecoveryCodes String[] // AES-256 encrypted recovery codes

  // Multi-Org Support (Phase 2: org switching)
  lastOrgId String? // Remember last active org for session resumption

  // CRM Relations
  contactsAssigned     Contact[]         @relation("ContactAssignee")
  contactNotesAuthored ContactNote[]     @relation("ContactNoteAuthor")
  contactActivities    ContactActivity[] @relation("ContactActivityActor")

  @@index([role])
}

// ARCHITECTURE NOTE — Deliberate Branding Duplication:
// Organization stores core branding (logo, brandColor, accentColor, favicon) set during GP Onboarding Wizard.
// Brand stores extended team-level branding (logo, brandColor, accentColor, banner, welcomeMessage) used by
// useTenantBranding hook and dataroom/LP-facing rendering. Both are cloud-stored URLs (S3/Vercel Blob).
// This duplication is intentional: Organization branding is org-wide defaults; Brand is team-specific overrides
// following the settings inheritance pattern (org_defaults → team_overrides). Consolidation would require
// refactoring useTenantBranding, all dataroom views, and the GP wizard — not safe without extensive testing.
// See also: Organization model lines ~3694-3698 for the org-level counterpart.
model Brand {
  id             String  @id @default(cuid())
  logo           String? // Cloud storage URL (S3/Vercel Blob). Duplicated on Organization for org-level default
  banner         String? // Banner image for dataroom view — Brand-only, not on Organization
  brandColor     String? // Hex color string. Duplicated on Organization for org-level default
  accentColor    String? // Hex color string. Duplicated on Organization for org-level default
  welcomeMessage String? // Welcome message for dataroom — Brand-only, not on Organization
  teamId         String  @unique
  team           Team    @relation(fields: [teamId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([identifier, token])
}

// Stores callback URLs separately to prevent email scanners from consuming tokens
model MagicLinkCallback {
  id            String   @id @default(cuid())
  identifier    String // email address
  token         String   @unique // random secure token for the email link
  callbackUrl   String // the actual NextAuth callback URL
  authTokenHash String // hash of the NextAuth verification token for exact matching
  expires       DateTime
  consumed      Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([identifier])
  @@index([expires])
}

model Domain {
  id          String   @id @default(cuid())
  slug        String   @unique
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId      String?
  teamId      String
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  verified    Boolean  @default(false) // Whether the domain has been verified
  isDefault   Boolean  @default(false) // Whether the domain is the primary domain
  lastChecked DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  links       Link[] // links associated with this domain

  @@index([userId])
  @@index([teamId])
}

model View {
  id                  String               @id @default(cuid())
  link                Link                 @relation(fields: [linkId], references: [id], onDelete: Restrict)
  linkId              String
  document            Document?            @relation(fields: [documentId], references: [id], onDelete: Restrict)
  documentId          String?
  dataroom            Dataroom?            @relation(fields: [dataroomId], references: [id], onDelete: Restrict)
  dataroomId          String?
  dataroomViewId      String? // This is the view ID from the dataroom
  viewerEmail         String? // Email of the viewer if known
  viewerName          String? // Name of the viewer if known
  verified            Boolean              @default(false) // Whether the viewer email has been verified
  viewedAt            DateTime             @default(now())
  downloadedAt        DateTime? // This is the time the document was downloaded
  downloadType        DownloadType? // Type of download: SINGLE, BULK, or FOLDER
  downloadMetadata    Json? // Metadata about the download (folder name, document list, etc.)
  reactions           Reaction[]
  viewType            ViewType             @default(DOCUMENT_VIEW)
  viewerId            String? // This is the viewer ID from the dataroom
  viewer              Viewer?              @relation(fields: [viewerId], references: [id], onDelete: Restrict)
  groupId             String? // This is the group ID from the dataroom
  group               ViewerGroup?         @relation(fields: [groupId], references: [id], onDelete: SetNull)
  feedbackResponse    FeedbackResponse?
  agreementResponse          AgreementResponse?
  accreditationGateResponse  AccreditationGateResponse?
  customFieldResponse        CustomFieldResponse?

  isArchived Boolean @default(false) // Indicates if the view is archived and not counted in the analytics

  // Audit Trail Fields (506(c) Compliance)
  ipAddress      String? // Viewer's IP address
  userAgent      String? // Browser user agent
  geoCountry     String? // Country from IP geolocation
  geoCity        String? // City from IP geolocation
  geoRegion      String? // Region/state from IP geolocation
  deviceType     String? // Desktop, Mobile, Tablet
  browserName    String? // Chrome, Firefox, Safari, etc.
  osName         String? // Windows, macOS, Linux, iOS, Android
  sessionId      String? // Unique session identifier
  referrer       String? // HTTP referrer URL
  referralSource String? // Custom referral source from ?ref= query parameter
  auditMetadata  Json? // Additional audit data (timestamps, actions, etc.)

  // conversation
  conversationViews    ConversationView[]
  messages             Message[]
  initialConversations Conversation[]     @relation("initialView")

  uploadedDocuments DocumentUpload[] // uploaded documents by this view

  // AI chats
  chats Chat[]

  // Page-level tracking
  pageViews PageView[]

  // Q&A System
  viewerNotes       ViewerNote[]
  dataroomQuestions DataroomQuestion[]

  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([linkId])
  @@index([dataroomId])
  @@index([dataroomViewId])
  @@index([groupId]) // Performance optimization for groupBy queries on groupId
  @@index([teamId])
  @@index([viewedAt(sort: Desc)]) // Performance optimization for date aggregations
  @@index([viewerId, documentId]) // Composite: covers viewerId-only queries via prefix scan + join filtering
  @@index([viewerEmail]) // Performance optimization for viewer email filtering
  @@index([documentId, isArchived]) // Composite: covers documentId-only queries via prefix scan + active views filtering
  @@index([documentId, viewedAt(sort: Desc)]) // Performance optimization for latest views queries
}

enum ViewType {
  DOCUMENT_VIEW
  DATAROOM_VIEW
}

enum UserRole {
  LP
  GP
}

model PageView {
  id            String   @id @default(cuid())
  viewId        String
  view          View     @relation(fields: [viewId], references: [id], onDelete: Cascade)
  linkId        String
  documentId    String
  dataroomId    String?
  versionNumber Int      @default(1)
  pageNumber    Int
  duration      Int      @default(0) // Duration in milliseconds
  viewedAt      DateTime @default(now())

  // Geo data
  country String @default("Unknown")
  city    String @default("Unknown")
  region  String @default("Unknown")

  // User agent data
  browser String @default("Unknown")
  os      String @default("Unknown")
  device  String @default("Desktop")

  @@index([viewId])
  // @@index([documentId]) — REMOVED: redundant, covered by @@index([documentId, viewId])
  @@index([linkId])
  @@index([dataroomId])
  @@index([documentId, viewId])
  @@index([documentId, pageNumber])
  @@index([documentId, versionNumber, pageNumber])
}

enum DownloadType {
  SINGLE // Individual document download
  BULK // Full dataroom bulk download
  FOLDER // Folder download
}

model Viewer {
  id                      String    @id @default(cuid())
  email                   String
  verified                Boolean   @default(false) // Whether the viewer email has been verified
  invitedAt               DateTime? // This is the time the viewer was invited
  notificationPreferences Json? // Format: { dataroom: {"dr_123": { "enabled": false }, "dr_456": { "enabled": true } } } }

  // SEC Compliance: Soft-delete for access revocation (preserves audit trail)
  accessRevokedAt     DateTime? // When access was revoked (null = active)
  accessRevokedBy     String? // User ID who revoked access
  accessRevokedReason String? // Reason for revocation (audit trail)

  dataroomId String?
  dataroom   Dataroom? @relation(fields: [dataroomId], references: [id], onDelete: SetNull)
  teamId     String
  team       Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  views                     View[]
  groups                    ViewerGroupMembership[]
  invitations               ViewerInvitation[]
  participatedConversations ConversationParticipant[]
  messages                  Message[]

  uploadedDocuments DocumentUpload[] // uploaded documents by this viewer

  // AI chats
  chats Chat[]

  // Q&A System
  dataroomQuestions DataroomQuestion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, email])
  // @@index([teamId]) — REMOVED: redundant, covered by @@unique([teamId, email])
  @@index([dataroomId])
  @@index([accessRevokedAt]) // For filtering active vs revoked viewers
}

model Reaction {
  id         String   @id @default(cuid())
  view       View     @relation(fields: [viewId], references: [id], onDelete: Cascade)
  viewId     String
  pageNumber Int
  type       String // e.g., "like", "dislike", "love", "hate", etc.
  createdAt  DateTime @default(now())

  // @@index([viewId]) — REMOVED: redundant, covered by @@index([viewId, type])
  @@index([viewId, type]) // Performance optimization for reaction grouping
}

model Invitation {
  email     String
  expires   DateTime
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  token     String   @unique

  @@unique([email, teamId])
}

enum EmailType {
  FIRST_DAY_DOMAIN_REMINDER_EMAIL
  FIRST_DOMAIN_INVALID_EMAIL
  SECOND_DOMAIN_INVALID_EMAIL
  FIRST_TRIAL_END_REMINDER_EMAIL
  FINAL_TRIAL_END_REMINDER_EMAIL
}

model SentEmail {
  id         String    @id @default(cuid())
  type       EmailType
  recipient  String // Email address of the recipient
  marketing  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  team       Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamId     String
  domainSlug String? // Domain that triggered the email. This can be nullable, representing emails not triggered by domains

  @@index([teamId])
}

model Chat {
  id    String  @id @default(cuid())
  title String? // Generated title from first message

  // Context associations
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  documentId String?
  document   Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)

  dataroomId String?
  dataroom   Dataroom? @relation(fields: [dataroomId], references: [id], onDelete: Cascade)

  linkId String?
  link   Link?   @relation(fields: [linkId], references: [id], onDelete: Cascade)

  viewId String?
  view   View?   @relation(fields: [viewId], references: [id], onDelete: Cascade)

  // User associations (internal or external)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  viewerId String?
  viewer   Viewer? @relation(fields: [viewerId], references: [id], onDelete: Cascade)

  // OpenAI references
  vectorStoreId String? // The vector store used for this chat

  messages ChatMessage[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastMessageAt DateTime? // Track latest activity

  @@index([teamId])
  @@index([documentId])
  @@index([dataroomId])
  @@index([linkId])
  @@index([userId])
  @@index([viewerId])
  @@index([viewId])
  @@index([createdAt(sort: Desc)])
}

model ChatMessage {
  id     String @id @default(cuid())
  chatId String
  chat   Chat   @relation(fields: [chatId], references: [id], onDelete: Cascade)

  role    String // "user" | "assistant" | "system"
  content String @db.Text

  // Optional structured data
  metadata Json? // Store sources, page numbers, confidence scores, etc.

  createdAt DateTime @default(now())

  // @@index([chatId]) — REMOVED: redundant, covered by @@index([chatId, createdAt])
  @@index([chatId, createdAt])
}

model Feedback {
  id     String @id @default(cuid())
  linkId String @unique
  link   Link   @relation(fields: [linkId], references: [id], onDelete: Cascade)
  data   Json // This will store the feedback question data: {question: "What is the purpose of this document?", type: "yes/no", options: ["Yes", "No"]}

  responses FeedbackResponse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([linkId])
}

model FeedbackResponse {
  id         String   @id @default(cuid())
  feedbackId String
  feedback   Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  data       Json // This will store the feedback question data: {question: "What is the purpose of this document?", type: "yes/no", options: ["Yes", "No"], answer: "Yes"}
  viewId     String   @unique
  view       View     @relation(fields: [viewId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([feedbackId])
  @@index([viewId])
}

model Agreement {
  id          String @id @default(cuid())
  name        String // Easily identifiable name for the agreement
  content     String // This will store the agreement content (URL or text)
  contentType String @default("LINK") // "LINK" or "TEXT" - determines how content should be displayed

  links     Link[]
  responses AgreementResponse[]

  requireName Boolean @default(true) // Optional require name field

  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deletedAt DateTime?
  deletedBy String?

  @@index([teamId])
}

model AgreementResponse {
  id          String    @id @default(cuid())
  agreementId String
  agreement   Agreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)
  viewId      String    @unique
  view        View      @relation(fields: [viewId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agreementId])
  @@index([viewId])
}

// Accreditation gate type — determines which checkboxes the visitor must confirm
enum AccreditationGateType {
  SELF_CERTIFICATION      // 3 checkboxes: accredited, risk awareness, own due diligence
  QUALIFIED_PURCHASER     // For 3(c)(7) funds: qualified purchaser + knowledgeable employee
  ACCREDITED_ONLY         // Single checkbox: I confirm I am an accredited investor
}

// Records a visitor's self-accreditation confirmation before viewing a protected link
model AccreditationGateResponse {
  id                   String   @id @default(cuid())
  linkId               String
  link                 Link     @relation(fields: [linkId], references: [id], onDelete: Cascade)
  viewId               String   @unique
  view                 View     @relation(fields: [viewId], references: [id], onDelete: Cascade)

  accreditationType    AccreditationGateType @default(SELF_CERTIFICATION)
  confirmedAccredited  Boolean  @default(false)  // "I am an accredited investor" checkbox
  confirmedRiskAware   Boolean  @default(false)  // "I understand the risks" checkbox
  confirmedOwnResearch Boolean  @default(false)  // "I've done my own due diligence" checkbox
  ipAddress            String?                    // Audit: viewer's IP at time of confirmation
  userAgent            String?                    // Audit: browser user agent

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([linkId])
  @@index([viewId])
}

model IncomingWebhook {
  id                  String    @id @default(cuid())
  externalId          String    @unique
  name                String
  secret              String? // Webhook signing secret for verification
  source              String? // Allowed source URL/domain
  actions             String? // comma separated (Eg: "documents:write,documentVersions:write")
  consecutiveFailures Int       @default(0)
  lastFailedAt        DateTime?
  disabledAt          DateTime?

  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
}

model RestrictedToken {
  id         String    @id @default(cuid())
  name       String
  hashedKey  String    @unique
  partialKey String
  scopes     String? // comma separated (Eg: "documents:write,links:write")
  expires    DateTime?
  lastUsed   DateTime?
  rateLimit  Int       @default(60) // rate limit per minute

  userId String
  teamId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([teamId])
}

model Webhook {
  id       String @id @default(cuid())
  pId      String @unique // public ID for the webhook
  name     String
  url      String
  secret   String // signing secret for the webhook
  triggers Json

  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
}

model YearInReview {
  id            String    @id @default(cuid())
  teamId        String
  team          Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  status        YearInReviewStatus @default(PENDING)
  attempts      Int       @default(0)
  lastAttempted DateTime?
  error         String?

  stats Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, attempts])
  @@index([teamId])
}

enum TagType {
  LINK_TAG
  DOCUMENT_TAG
  DATAROOM_TAG
}

model Tag {
  id          String  @id @default(cuid())
  name        String
  color       String
  description String?

  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  items TagItem[]

  // NAMING INCONSISTENCY: `createdBy` is a plain String storing userId without FK constraint.
  // Best-practice pattern uses `createdById String` + `createdBy User @relation(...)` (see LPDocument, SignatureDocument, Deal).
  // Phase 2: Rename to `createdById`, add User @relation for referential integrity and type-safe queries.
  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // @@index([id]) — REMOVED: redundant, @id already creates a primary key index

  @@unique([teamId, name])
  // @@index([teamId]) — REMOVED: redundant, covered by @@unique([teamId, name])
  @@index([name])
}

model TagItem {
  id       String  @id @default(cuid())
  tagId    String
  tag      Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)
  itemType TagType

  // tag can be linked to a link, document or dataroom
  linkId     String?
  link       Link?     @relation(fields: [linkId], references: [id], onDelete: Cascade)
  documentId String?
  document   Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)
  dataroomId String?
  dataroom   Dataroom? @relation(fields: [dataroomId], references: [id], onDelete: Cascade)

  taggedBy  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tagId, linkId])
  @@index([tagId, documentId])
  @@index([tagId, dataroomId])
}

model ViewerInvitation {
  id            String           @id @default(cuid())
  viewerId      String
  viewer        Viewer           @relation(fields: [viewerId], references: [id], onDelete: Cascade)
  linkId        String
  link          Link             @relation(fields: [linkId], references: [id], onDelete: Cascade)
  groupId       String?
  group         ViewerGroup?     @relation(fields: [groupId], references: [id], onDelete: SetNull)
  invitedBy     String
  customMessage String?
  sentAt        DateTime         @default(now())
  status        InvitationStatus @default(SENT)

  createdAt DateTime @default(now())

  @@index([viewerId])
  @@index([linkId])
  @@index([groupId])
}

enum InvitationStatus {
  SENT
  FAILED
  BOUNCED
}

// --- From investor.prisma ---
model Investor {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Fund Association (many-to-one: multiple investors per fund)
  fundId String?
  fund   Fund?   @relation(fields: [fundId], references: [id], onDelete: SetNull)

  entityName String?
  entityType String  @default("INDIVIDUAL")
  taxId      String? // Encrypted via encryptTaxId() — stores AES-256-GCM ciphertext
  // @deprecated — Legacy single-line address field. Replaced by structured address fields below
  // (addressLine1, city, state, postalCode, country). Retained for backward compatibility with
  // older investor records. New code MUST use the structured fields. Do NOT write to this field.
  // Safe to remove once all existing records have been migrated to structured fields (Phase 2 migration).
  address    String?
  phone      String?

  // Structured address fields (master plan) — USE THESE instead of `address` above
  addressLine1      String?
  addressLine2      String?
  city              String?
  state             String?
  postalCode        String?
  country           String? @default("US")
  useMailingAddress Boolean @default(false) // Separate mailing address

  // Mailing address (when different from physical)
  mailingAddressLine1 String?
  mailingAddressLine2 String?
  mailingCity         String?
  mailingState        String?
  mailingPostalCode   String?
  mailingCountry      String?

  // Individual-specific fields
  dateOfBirth String? // ISO date string
  citizenship String? @default("US") // ISO country code

  // LLC / Other entity fields
  stateOfFormation    String? // US state code
  dateOfFormation     String? // ISO date string
  taxClassification   String? // DISREGARDED_ENTITY, PARTNERSHIP, S_CORPORATION, C_CORPORATION
  authorizedSignatory String? // Signer full name
  signatoryTitle      String? // e.g., "Managing Member", "Director"

  // Trust-specific fields
  trustType      String? // REVOCABLE, IRREVOCABLE, FAMILY, CHARITABLE, OTHER
  trustDate      String? // Date established (ISO date string)
  trusteeName    String? // Trustee full name
  governingState String? // State governing the trust

  // Retirement account fields
  accountType             String? // TRADITIONAL_IRA, ROTH_IRA, SOLO_401K, SEP_IRA, SIMPLE_IRA
  accountTitle            String? // "FBO [Account Holder Name]"
  custodianCoSignRequired Boolean @default(true) // Most custodians require co-signature

  // Individual SEC compliance fields
  sourceOfFunds String? // SALARY, INVESTMENT_RETURNS, BUSINESS_INCOME, INHERITANCE, OTHER
  occupation    String? // Occupation / employer

  // Custodian fields (for IRA/401k entity types)
  custodianName    String?
  custodianAccount String?
  custodianEin     String? // Encrypted via encryptTaxId()

  // Other entity fields
  otherEntityType    String? // CORPORATION, LIMITED_PARTNERSHIP, GENERAL_PARTNERSHIP, S_CORPORATION, NON_PROFIT, FOREIGN_ENTITY, OTHER
  countryOfFormation String? @default("US")

  // Entity-specific nested data (signatory contact, custodian address/contact, account holder, etc.)
  entityData Json?

  // Lead tracking & profile approval
  leadSource            String? // DIRECT, REFERRAL, MARKETPLACE, DATAROOM, etc.
  profileApprovalStatus String? // PENDING, APPROVED, CHANGES_REQUESTED, REJECTED
  // NAMING INCONSISTENCY: `approvedBy` is a plain String storing userId without FK constraint.
  // Best-practice pattern uses `approvedByUserId String` + `approvedBy User @relation(...)`.
  // Phase 2: Rename to `approvedByUserId`, add User @relation for referential integrity.
  approvedBy            String?
  approvedAt            DateTime?

  fundData   Json?
  signedDocs Json?

  // Accreditation Status
  accreditationStatus      AccreditationStatus @default(PENDING)
  accreditationType        String? // INCOME, NET_WORTH, PROFESSIONAL, ENTITY, OTHER
  accreditationExpiresAt   DateTime? // Annual re-verification for 506(c)
  accreditationMethod      String? // SELF_ACK, MIN_INVESTMENT_THRESHOLD, INCOME_VERIFIED, NET_WORTH_VERIFIED, THIRD_PARTY_LETTER, PERSONA_KYC
  accreditationCategory    String? // INCOME, NET_WORTH, PROFESSIONAL, ENTITY_ASSETS, ENTITY_OWNERS — Rule 501(a) subcategory
  selfFinancingConfirmed   Boolean             @default(false) // 506(c): confirmed investment is not third-party financed
  accreditationDocumentIds String[] // Array of LPDocument IDs that verify accreditation (506(c) third-party letter, income proof, etc.)

  // Persona KYC/AML Integration
  personaInquiryId   String? // Persona inquiry ID
  personaStatus      String    @default("NOT_STARTED") // NOT_STARTED, PENDING, APPROVED, DECLINED, NEEDS_REVIEW, EXPIRED
  personaVerifiedAt  DateTime?
  personaReferenceId String? // Our internal reference ID sent to Persona
  personaData        Json? // Full Persona verification response data

  // NDA Gate
  ndaSigned   Boolean   @default(false)
  ndaSignedAt DateTime?

  // Onboarding Progress
  onboardingStep        Int       @default(0)
  onboardingCompletedAt DateTime?

  investments       Investment[]
  capitalCalls      CapitalCallResponse[]
  notes             InvestorNote[]
  accreditationAcks AccreditationAck[]
  documents         InvestorDocument[]
  bankLinks         BankLink[]
  transactions      Transaction[]
  entities          EntityInvestor[]
  manualInvestments ManualInvestment[]
  lpDocuments       LPDocument[]

  // Marketplace
  dealInterests   DealInterest[]
  dealAllocations DealAllocation[]

  // Onboarding & Change Requests
  onboardingFlows       OnboardingFlow[]
  profileChangeRequests ProfileChangeRequest[]

  // CRM Contact link (one-to-one, contact may reference this investor)
  contact Contact?

  // Stripe (Phase 2: ACH Direct Debit)
  stripeCustomerId String? // Stripe Customer ID for ACH payments

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  // @@index([fundId]) — REMOVED: redundant, covered by @@index([fundId, accreditationStatus])
  @@index([accreditationStatus])
  @@index([fundId, accreditationStatus])
}

model InvestorDocument {
  id         String   @id @default(cuid())
  investorId String
  investor   Investor @relation(fields: [investorId], references: [id], onDelete: Restrict)

  title        String
  documentType String              @default("OTHER")
  storageKey   String
  storageType  DocumentStorageType @default(S3_PATH)

  signatureDocumentId String
  signedAt            DateTime?

  ipAddress  String?
  userAgent  String?
  auditTrail Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([investorId, signatureDocumentId])
  @@index([investorId])
  @@index([signatureDocumentId])
  @@index([documentType])
}

// LP Document Upload Types - categories for investor-submitted documents
enum LPDocumentType {
  NDA
  SUBSCRIPTION_AGREEMENT
  LPA
  SIDE_LETTER
  K1_TAX_FORM
  PROOF_OF_FUNDS
  WIRE_CONFIRMATION
  ACH_RECEIPT
  ACCREDITATION_PROOF
  IDENTITY_DOCUMENT
  FORMATION_DOCS
  POWER_OF_ATTORNEY
  TRUST_DOCUMENTS
  CUSTODIAN_DOCUMENTS
  OTHER
}

// LP Document Upload Source - tracks how and by whom the document was uploaded
enum LPDocumentUploadSource {
  LP_UPLOADED // LP uploaded directly via portal
  LP_UPLOADED_EXTERNAL // LP uploaded an externally-signed document
  GP_UPLOADED_FOR_LP // GP uploaded on behalf of LP (auto-confirmed)
  PLATFORM_SIGNED // Document signed via FundRoom Sign
  SYSTEM_GENERATED // System-generated document (K-1, reports, etc.)
}

// LP Document Review Status - tracks document through approval workflow
enum LPDocumentStatus {
  UPLOADED_PENDING_REVIEW
  APPROVED
  REJECTED
  REVISION_REQUESTED
  ARCHIVED
}

enum InvestorStage {
  APPLIED
  UNDER_REVIEW
  APPROVED
  REJECTED
  COMMITTED
  DOCS_APPROVED
  FUNDED
}

enum InvestmentStatus {
  APPLIED
  COMMITTED
  DOCS_APPROVED
  PARTIALLY_FUNDED
  FUNDED
  CANCELLED
  DECLINED
  WITHDRAWN
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  PROOF_UPLOADED
}

enum TransactionType {
  CAPITAL_CALL
  DISTRIBUTION
  WIRE_TRANSFER
  SUBSCRIPTION_PAYMENT
}

enum AccreditationStatus {
  PENDING
  SELF_CERTIFIED
  THIRD_PARTY_VERIFIED
  KYC_VERIFIED
  EXPIRED
}

enum InvestmentTrancheStatus {
  SCHEDULED
  CALLED
  PARTIALLY_FUNDED
  FUNDED
  OVERDUE
  DEFAULTED
  CANCELLED
}

enum FundStatus {
  RAISING
  ACTIVE
  DEPLOYED
  CLOSED
  LIQUIDATING
}

enum ActivationStatus {
  PENDING
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

// LP Document - investor-submitted documents requiring GP review
model LPDocument {
  id         String   @id @default(cuid())
  investorId String
  investor   Investor @relation(fields: [investorId], references: [id], onDelete: Restrict)
  fundId     String
  fund       Fund     @relation(fields: [fundId], references: [id], onDelete: Restrict)

  // Document metadata
  title            String
  documentType     LPDocumentType
  status           LPDocumentStatus @default(UPLOADED_PENDING_REVIEW)
  storageKey       String
  storageType      DocumentStorageType @default(REPLIT)
  originalFilename String?
  fileSize         BigInt?
  mimeType         String?
  numPages         Int?

  // LP submission details
  uploadedByUserId    String
  uploadedBy          User                   @relation("LPDocumentUploader", fields: [uploadedByUserId], references: [id], onDelete: Restrict)
  uploadSource        LPDocumentUploadSource @default(LP_UPLOADED)
  lpNotes             String?
  isOfflineSigned     Boolean                @default(false)
  externalSigningDate DateTime?

  // GP review details
  reviewedByUserId String?
  reviewedBy       User?     @relation("LPDocumentReviewer", fields: [reviewedByUserId], references: [id], onDelete: SetNull)
  reviewedAt       DateTime?
  reviewNotes      String?

  // Optional link to investment/commitment
  investmentId String?
  investment   Investment? @relation(fields: [investmentId], references: [id], onDelete: SetNull)

  // Client-side encryption metadata
  isClientEncrypted Boolean @default(false)
  encryptionKeyHash String?
  encryptionIv      String?

  // Review history
  reviews LPDocumentReview[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // @@index([investorId]) — REMOVED: redundant, covered by @@index([investorId, status])
  // @@index([fundId]) — REMOVED: redundant, covered by @@index([fundId, status])
  @@index([status])
  @@index([documentType])
  @@index([uploadedByUserId])
  @@index([uploadSource])
  @@index([reviewedByUserId])
  @@index([deletedAt])
  @@index([fundId, status])
  @@index([investorId, status])
  @@index([fundId, investorId])
  @@index([investorId, documentType])
}

// LP Document Review - audit trail of all review actions
model LPDocumentReview {
  id             String           @id @default(cuid())
  documentId     String
  document       LPDocument       @relation(fields: [documentId], references: [id], onDelete: Restrict)
  reviewerUserId String
  reviewer       User             @relation(fields: [reviewerUserId], references: [id], onDelete: Restrict)
  status         LPDocumentStatus
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([documentId])
  @@index([reviewerUserId])
}

model AccreditationAck {
  id         String   @id @default(cuid())
  investorId String
  investor   Investor @relation(fields: [investorId], references: [id], onDelete: Restrict)

  acknowledged Boolean @default(false)
  method       String  @default("SELF_CERTIFIED")

  // 506(c) Compliance: Accreditation Type Selection
  accreditationType    String? // INCOME, NET_WORTH, PROFESSIONAL, ENTITY, OTHER
  accreditationDetails Json? // Structured data for selected type

  // Self-Acknowledgment Checkboxes (506(c) "Reasonable Steps")
  confirmAccredited      Boolean @default(false) // "I confirm I am an accredited investor"
  confirmRiskAware       Boolean @default(false) // "I understand the risks of private investments"
  confirmDocReview       Boolean @default(false) // "I have reviewed the offering documents"
  confirmRepresentations Boolean @default(false) // "My representations are true and accurate"

  // SEC Guidance: Auto-Approval & Review Flagging
  autoApproved         Boolean   @default(false) // Met minimum commitment + self-attest
  needsManualReview    Boolean   @default(false) // Flagged for GP/admin review
  reviewedAt           DateTime? // When manual review was completed
  // NAMING INCONSISTENCY: `reviewedBy` is a plain String storing userId without FK constraint.
  // Phase 2: Rename to `reviewedByUserId`, add User @relation for referential integrity.
  reviewedBy           String?
  reviewNotes          String? // Notes from manual review
  minimumCommitmentMet Boolean   @default(false) // Commitment >= fund minimum
  commitmentAmount     Decimal?  @db.Decimal(15, 2) // Actual commitment amount

  // KYC Integration Hooks (for future API connection)
  kycProvider       String? // PLAID, PARALLEL_MARKETS, VERIFY_INVESTOR, etc.
  kycVerificationId String? // External verification ID
  kycStatus         String? // PENDING, VERIFIED, FAILED, EXPIRED
  kycVerifiedAt     DateTime?
  kycData           Json? // Structured KYC response data

  // Full Audit Trail for SEC Compliance
  ipAddress      String
  userAgent      String
  sessionId      String? // Browser session tracking
  geoLocation    String? // Derived from IP
  completedSteps Json? // Track wizard progress

  // Timestamps
  startedAt   DateTime  @default(now()) // When wizard was started
  completedAt DateTime? // When fully completed
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([investorId])
  @@index([kycStatus])
  @@index([method])
  @@index([createdAt])
}

// Entity Mode: Determines whether this is a Fund (LP/GP with units/calls) or Startup (cap table with shares)
enum EntityMode {
  FUND // Traditional fund: units, capital calls, distributions, K1s
  STARTUP // Startup equity: shares, price per share, vesting, cap table
}

// Waterfall Type: Determines distribution waterfall calculation method (Phase 2 waterfall engine)
enum WaterfallType {
  EUROPEAN // Return all capital first, then carry on all profits (GP-unfriendly)
  AMERICAN // Carry on each deal as realized (GP-friendly, aka "deal-by-deal")
  DEAL_BY_DEAL // Alias for American — carry calculated per investment
}

// Payment Method: How funds were transferred
enum PaymentMethodType {
  MANUAL_WIRE // Bank wire transfer (MVP default)
  ACH_DIRECT_DEBIT // Stripe ACH Direct Debit (Phase 2)
  CHECK // Physical check
  CRYPTO // Cryptocurrency transfer (future)
}

// Email Digest Frequency: How often notification digests are sent
enum EmailDigestFrequency {
  REALTIME // Send immediately (no batching)
  DAILY // Once per day digest
  WEEKLY // Once per week digest
  NEVER // No email digests
}

model Fund {
  id     String @id @default(cuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Restrict)

  name        String
  description String?
  style       String? // e.g., "Staged Commitments", "Traditional", "Evergreen"

  // Entity Mode: FUND (default) or STARTUP for cap table features
  entityMode EntityMode @default(FUND)

  // Feature Flags (fund-level overrides)
  featureFlags Json? // { "kyc.required": true, ... }

  targetRaise       Decimal  @db.Decimal(18, 2)
  minimumInvestment Decimal  @db.Decimal(18, 2)
  currentRaise      Decimal  @default(0) @db.Decimal(18, 2)
  aumTarget         Decimal? @db.Decimal(18, 2) // Optional AUM goal

  status      FundStatus @default(RAISING)
  closingDate DateTime?

  ndaGateEnabled Boolean @default(true)

  // Initial Closing Threshold (gates capital calls until met)
  initialThresholdEnabled Boolean  @default(false)
  initialThresholdAmount  Decimal? @db.Decimal(18, 2) // e.g., $1.8M before first capital use

  // Full Authorized Amount (for progress tracking, not gating)
  fullAuthorizedAmount Decimal? @db.Decimal(18, 2) // e.g., $9.55M raise target

  // Legacy: Configurable Capital Call Threshold (deprecated, use initialThreshold*)
  capitalCallThresholdEnabled Boolean  @default(false)
  capitalCallThreshold        Decimal? @db.Decimal(18, 2)

  // Call Frequency Configuration
  callFrequency String @default("AS_NEEDED") // AS_NEEDED, MONTHLY, QUARTERLY, SEMI_ANNUAL, ANNUAL

  // Staged Commitments
  stagedCommitmentsEnabled Boolean @default(false)

  // Flexible Custom Settings (JSON for extensibility)
  customSettings Json?

  // SEC Form D Compliance
  formDFilingDate      DateTime? // Date Form D was filed with SEC
  formDAmendmentDue    DateTime? // Annual amendment due date (1 year after initial)
  formDReminderSent    Boolean   @default(false) // Reminder notification sent
  stateNoticesRequired Json? // Array of { state, filed, filedAt, dueDate }

  // Audit and Tracking
  // NAMING INCONSISTENCY: `createdBy` is a plain String storing userId without FK constraint.
  // Best-practice pattern uses `createdById String` + `createdBy User @relation(...)` (see SignatureDocument, Deal).
  // Phase 2: Rename to `createdById`, add User @relation for referential integrity and type-safe queries.
  createdBy String?
  audit     Json? // Changes log: [{ timestamp, userId, action, previousValue, newValue }]

  flatModeEnabled Boolean @default(false)

  // Wire Transfer Instructions (for Manual Wire MVP)
  wireInstructions          Json? // { bankName, accountNumber, routingNumber, swiftCode, beneficiaryName, beneficiaryAddress, reference, notes, intermediaryBank? }
  wireInstructionsUpdatedAt DateTime?
  wireInstructionsUpdatedBy String?

  // Fund Economics (Master Plan required fields)
  managementFeePct Decimal? @db.Decimal(5, 4) // e.g., 0.0200 = 2.00%
  carryPct         Decimal? @db.Decimal(5, 4) // e.g., 0.2000 = 20.00%
  hurdleRate       Decimal? @db.Decimal(5, 4) // e.g., 0.0800 = 8.00%
  catchUpPct       Decimal? @db.Decimal(5, 4) // e.g., 1.0000 = 100% catch-up after hurdle (Phase 2 waterfall engine)
  orgFeePct        Decimal? @db.Decimal(5, 4) // e.g., 0.0050 = 0.50% organizational fee
  expenseRatioPct  Decimal? @db.Decimal(5, 4) // e.g., 0.0030 = 0.30% operating expenses
  waterfallType    String? // "EUROPEAN", "AMERICAN", "DEAL_BY_DEAL"
  currency         String   @default("USD") // ISO 4217 currency code

  // AUM Calculation Frequency
  aumCalculationFrequency String @default("DAILY") // DAILY, WEEKLY, MONTHLY, ANNUAL

  // Fund Term
  termYears      Int? // Fund term in years (e.g., 10)
  extensionYears Int? // Maximum extension in years (e.g., 2)

  // Fund Sub-Type (for GP_FUND mode)
  fundSubType String? // VENTURE_CAPITAL, PRIVATE_EQUITY, REAL_ESTATE, HEDGE_FUND, SPV_COINVEST, SEARCH_FUND, FUND_OF_FUNDS, CUSTOM

  // High-Water Mark (hedge funds)
  highWaterMark Boolean @default(false)

  // GP Commitment
  gpCommitmentAmount Decimal? @db.Decimal(18, 2)
  gpCommitmentPct    Decimal? @db.Decimal(5, 4) // e.g., 0.0500 = 5.00%

  // Advanced Provisions
  recyclingEnabled        Boolean  @default(false) // Reinvest returned capital
  keyPersonEnabled        Boolean  @default(false) // Key person clause active
  keyPersonName           String? // Name of the key person (shown when keyPersonEnabled=true)
  noFaultDivorceThreshold Decimal? @db.Decimal(5, 2) // LP supermajority % to remove GP (e.g., 75.00)
  investmentPeriodYears   Int? // Active investment period in years
  preferredReturnMethod   String?  @default("COMPOUNDED") // COMPOUNDED or SIMPLE
  clawbackProvision       Boolean? @default(true) // GP must return excess carry if fund underperforms
  mgmtFeeOffsetPct        Decimal? @db.Decimal(5, 2) // % of portfolio company fees that offset mgmt fees (e.g., 100.00)

  // SEC Exemption Type
  regulationDExemption String?

  // Startup Raise Instrument Fields
  instrumentType              String? // "LPA" | "SAFE" | "CONVERTIBLE_NOTE" | "PRICED_ROUND"
  fundStrategy                String? // "PE" | "VC" | "REAL_ESTATE" | "HEDGE" | "FUND_OF_FUNDS" | "OTHER"
  safeType                    String? // "POST_MONEY" | "PRE_MONEY"
  valuationCap                Decimal?  @db.Decimal(18, 2) // SAFE/Conv Note valuation cap
  discountRatePct             Decimal?  @db.Decimal(5, 4) // SAFE/Conv Note discount (e.g., 0.2000 = 20%)
  interestRatePct             Decimal?  @db.Decimal(5, 4) // Conv Note annual interest (e.g., 0.0500 = 5%)
  maturityDate                DateTime? // Conv Note maturity date
  qualifiedFinancingThreshold Decimal?  @db.Decimal(18, 2) // Conv Note auto-conversion threshold
  preMoneyValuation           Decimal?  @db.Decimal(18, 2) // Priced Round pre-money valuation
  liquidationPreference       String? // "1X_NON_PARTICIPATING" | "1X_PARTICIPATING" | "2X_NON_PARTICIPATING"
  antiDilutionType            String? // "BROAD_BASED_WEIGHTED_AVG" | "FULL_RATCHET"
  optionPoolPct               Decimal?  @db.Decimal(5, 4) // ESOP pool as decimal (e.g., 0.1000 = 10%)

  // SEC / Investment Company Act
  investmentCompanyExemption String? // "3C1" (max 100 investors) | "3C7" (qualified purchasers only)
  useOfProceeds              String? @db.Text // Form D Item 15 — description of intended use of offering proceeds
  salesCommissions           String? // Form D Item 16 — broker-dealer commission structure

  // Marketplace
  marketplaceInterest     Boolean   @default(false) // GP intent to list on FundRoom Marketplace (V2)
  marketplaceDescription  String?   @db.Text // Brief fund description for marketplace (280 char max)
  marketplaceCategory     String? // VC, PE, Real Estate, Infrastructure, Credit, Multi-Strategy, Other
  marketplaceInterestDate DateTime? // Date when GP opted in to marketplace

  investments       Investment[]
  capitalCalls      CapitalCall[]
  distributions     Distribution[]
  reports           FundReport[]
  aggregate         FundAggregate?
  investors         Investor[]
  pricingTiers      FundPricingTier[]
  subscriptions     Subscription[]
  manualInvestments ManualInvestment[]
  lpDocuments       LPDocument[]
  fundCloses        FundClose[]

  // Marketplace deals linked to this fund
  deals Deal[]

  // E-Signature documents for this fund (NDA, Subscription Agreement, LPA, etc.)
  signatureDocuments SignatureDocument[]

  // Document Templates — HTML templates with merge fields for this fund
  documentTemplates DocumentTemplate[] @relation("FundDocumentTemplates")

  // Wire/capital transactions linked to this fund
  transactions Transaction[]

  // AUM snapshots (historical AUM calculations)
  aumSnapshots AumSnapshot[]

  // Onboarding & Change Requests & Activation
  onboardingFlows       OnboardingFlow[]
  profileChangeRequests ProfileChangeRequest[]
  fundroomActivations   FundroomActivation[]
  offeringPages         OfferingPage[]

  // Startup mode funding rounds (Pre-Seed, Seed, Series A, etc.)
  fundingRounds FundingRound[]

  // Phase 2: Cap Table (Startup Mode)
  capTableEntries CapTableEntry[]

  // Phase 2: Waterfall Calculations (GP Fund Mode)
  waterfallCalculations WaterfallCalculation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([createdBy])
  @@index([status])
}

model FundAggregate {
  id     String @id @default(cuid())
  fundId String @unique
  fund   Fund   @relation(fields: [fundId], references: [id], onDelete: Restrict)

  // Financial Aggregates
  totalInbound   Decimal @default(0) @db.Decimal(15, 2) // Capital calls received
  totalOutbound  Decimal @default(0) @db.Decimal(15, 2) // Distributions paid
  totalCommitted Decimal @default(0) @db.Decimal(15, 2) // From subscriptions
  currentBalance Json? // Breakdowns by type/period

  // Initial Closing Threshold (gates capital calls)
  initialThresholdEnabled Boolean   @default(false)
  initialThresholdAmount  Decimal?  @db.Decimal(15, 2) // e.g., $1.8M
  initialThresholdMet     Boolean   @default(false) // True when totalCommitted >= initialThresholdAmount
  initialThresholdMetAt   DateTime? // When threshold was first met

  // Full Authorized Amount Progress (tracking only, not gating)
  fullAuthorizedAmount   Decimal? @db.Decimal(15, 2) // e.g., $9.55M
  fullAuthorizedProgress Decimal  @default(0) @db.Decimal(5, 2) // Percentage (0-100)

  // Legacy: Configurable Threshold (deprecated, use initialThreshold*)
  thresholdEnabled Boolean  @default(false)
  thresholdAmount  Decimal? @db.Decimal(15, 2)

  // Audit Trail for Changes
  audit Json? // Array of { ip, timestamp, userAgent, action, previousValue, newValue }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fundId])
}

model AumSnapshot {
  id     String @id @default(cuid())
  fundId String
  fund   Fund   @relation(fields: [fundId], references: [id], onDelete: Restrict)

  date   DateTime // The date this snapshot covers
  period String // DAILY, WEEKLY, MONTHLY, ANNUAL

  // Core AUM Metrics
  grossAum Decimal @db.Decimal(18, 2)
  netAum   Decimal @db.Decimal(18, 2)
  nav      Decimal @db.Decimal(18, 2) // Net Asset Value

  // Capital Metrics
  totalCommitted   Decimal @db.Decimal(18, 2)
  totalFunded      Decimal @db.Decimal(18, 2)
  totalDistributed Decimal @db.Decimal(18, 2)

  // Fee Deductions (calculated using fund-specific rates)
  managementFees  Decimal @default(0) @db.Decimal(18, 2)
  performanceFees Decimal @default(0) @db.Decimal(18, 2)
  orgFees         Decimal @default(0) @db.Decimal(18, 2)
  expenses        Decimal @default(0) @db.Decimal(18, 2)
  totalDeductions Decimal @default(0) @db.Decimal(18, 2)

  // Snapshot Context
  investorCount Int   @default(0)
  metadata      Json? // Additional breakdown details

  // Fee Rates Used (snapshot of rates at time of calculation)
  managementFeeRate Decimal? @db.Decimal(5, 4) // Rate used for this snapshot
  carryRate         Decimal? @db.Decimal(5, 4)
  orgFeeRate        Decimal? @db.Decimal(5, 4)
  expenseRate       Decimal? @db.Decimal(5, 4)

  createdAt DateTime @default(now())

  @@unique([fundId, date, period])
  @@index([fundId, period, date])
  @@index([date])
}

model Investment {
  id         String   @id @default(cuid())
  fundId     String
  fund       Fund     @relation(fields: [fundId], references: [id], onDelete: Restrict)
  investorId String
  investor   Investor @relation(fields: [investorId], references: [id], onDelete: Restrict)

  commitmentAmount Decimal          @db.Decimal(18, 2)
  fundedAmount     Decimal          @default(0) @db.Decimal(18, 2)
  status           InvestmentStatus @default(COMMITTED)
  subscriptionDate DateTime?

  // Staged Commitment Fields
  isStaged     Boolean @default(false) // True if this commitment is split into tranches
  schedule     String? // "monthly", "quarterly", "semi_annual", "custom"
  trancheCount Int? // Number of tranches (2-12)

  // Fund Close Association
  fundCloseId String?
  fundClose   FundClose? @relation(fields: [fundCloseId], references: [id], onDelete: SetNull)

  lpDocuments LPDocument[]
  tranches    InvestmentTranche[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fundId, investorId])
  // @@index([fundId]) — REMOVED: redundant, covered by @@unique([fundId, investorId]) and @@index([fundId, status])
  @@index([investorId])
  @@index([fundCloseId])
  @@index([isStaged])
  @@index([fundId, status])
  @@index([fundId, isStaged])
}

model CapitalCall {
  id     String @id @default(cuid())
  fundId String
  fund   Fund   @relation(fields: [fundId], references: [id], onDelete: Restrict)

  callNumber        Int
  amount            Decimal           @db.Decimal(18, 2)
  purpose           String?
  dueDate           DateTime
  status            CapitalCallStatus @default(DRAFT)
  proRataPercentage Decimal?          @db.Decimal(5, 4) // e.g. 0.2500 = 25%
  notes             String?           @db.Text // Internal GP notes

  // Lifecycle timestamps
  noticeDate  DateTime? // When notice was sent to LPs
  sentAt      DateTime? // When email notices went out
  fundedAt    DateTime? // When fully funded
  cancelledAt DateTime? // When cancelled

  // Generated notice
  noticePdfUrl String? // Generated PDF notice URL

  // Audit
  createdBy String // userId who created the call

  responses CapitalCallResponse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // @@index([fundId]) — REMOVED: redundant, covered by @@index([fundId, status])
  @@index([fundId, status])
}

enum CapitalCallStatus {
  DRAFT
  PENDING
  SENT
  PARTIALLY_FUNDED
  FUNDED
  CANCELLED
  OVERDUE
  COMPLETED
}

model CapitalCallResponse {
  id            String      @id @default(cuid())
  capitalCallId String
  capitalCall   CapitalCall @relation(fields: [capitalCallId], references: [id], onDelete: Restrict)
  investorId    String
  investor      Investor    @relation(fields: [investorId], references: [id], onDelete: Restrict)

  amountDue  Decimal                   @db.Decimal(18, 2)
  amountPaid Decimal                   @default(0) @db.Decimal(18, 2)
  status     CapitalCallResponseStatus @default(PENDING)
  paidAt     DateTime?

  // Wire proof tracking
  proofDocumentId String? // Link to uploaded wire proof document
  proofUploadedAt DateTime?

  // GP confirmation
  confirmedBy      String? // GP userId who confirmed receipt
  confirmedAt      DateTime?
  fundReceivedDate DateTime? // The legal date funds were received
  notes            String?   @db.Text // GP notes on this response

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([capitalCallId, investorId])
  @@index([capitalCallId])
  @@index([investorId])
  @@index([status]) // Filter by response status (PENDING, COMMITTED, FUNDED, DECLINED)
}

enum CapitalCallResponseStatus {
  PENDING
  COMMITTED
  FUNDED
  DECLINED
  PARTIAL
}

// ─── Tranche Persistence ────────────────────────────────────────────────────
// Tracks individual tranche installments for staged commitments.
// When an LP splits a commitment into 2-12 tranches via the staged commitment
// wizard, each tranche becomes an InvestmentTranche row with its own lifecycle.
model InvestmentTranche {
  id           String     @id @default(cuid())
  investmentId String
  investment   Investment @relation(fields: [investmentId], references: [id], onDelete: Restrict)

  // Tranche Identity
  trancheNumber Int // 1-indexed order within the investment
  label         String // "Initial Capital Call", "Tranche 2", etc.

  // Financial
  amount       Decimal @db.Decimal(18, 2) // Scheduled amount for this tranche
  fundedAmount Decimal @default(0) @db.Decimal(18, 2) // Actually funded so far

  // Schedule & Dates
  scheduledDate DateTime // When this tranche payment is due
  calledDate    DateTime? // When capital call was issued for this tranche
  fundedDate    DateTime? // When payment was confirmed received
  overdueDate   DateTime? // When tranche was marked overdue (if applicable)

  // Status Lifecycle:
  //   SCHEDULED → CALLED → PARTIALLY_FUNDED → FUNDED (happy path)
  //   SCHEDULED → OVERDUE → DEFAULTED (unhappy path)
  //   Any → CANCELLED (if commitment restructured)
  status InvestmentTrancheStatus @default(SCHEDULED)

  // Capital Call Link (optional — null until a capital call targets this tranche)
  capitalCallId String?

  // Wire Proof Link (for manual wire MVP — links to LPDocument if proof uploaded)
  wireProofDocumentId String?

  // Audit & Metadata
  metadata  Json? // Additional tranche metadata (e.g., GP adjustment notes)
  notes     String? // GP notes on this tranche
  ipAddress String? // IP from which tranche was created (506(c) compliance)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([investmentId, trancheNumber])
  // @@index([investmentId]) — REMOVED: redundant, covered by @@unique([investmentId, trancheNumber]) and @@index([investmentId, status])
  @@index([status])
  @@index([scheduledDate])
  @@index([investmentId, status])
  @@index([capitalCallId])
}

// ─── Fund Closing Rounds ────────────────────────────────────────────────────
// Tracks fund closing rounds (First Close, Second Close, Final Close).
// PE/VC funds typically raise capital in multiple closes. Each close locks in
// a cohort of investors at a specific point in time.
model FundClose {
  id     String @id @default(cuid())
  fundId String
  fund   Fund   @relation(fields: [fundId], references: [id], onDelete: Restrict)

  // Close Identity
  closeNumber Int // 1 = First Close, 2 = Second Close, etc.
  name        String // "First Close", "Second Close", "Final Close"

  // Financial
  targetAmount Decimal? @db.Decimal(18, 2) // Target for this close round
  actualAmount Decimal  @default(0) @db.Decimal(18, 2) // Sum of committed capital in this close

  // Dates
  openDate           DateTime  @default(now()) // When this close round opened for commitments
  scheduledCloseDate DateTime? // Target close date
  closeDate          DateTime? // Actual close date (null if still open)

  // Status: OPEN → CLOSED → FINAL
  status  FundCloseStatus @default(OPEN)
  isFinal Boolean         @default(false) // True if this is the final close (no more closes after)

  // Audit
  closedBy String? // userId who closed the round
  metadata Json? // Additional close metadata
  notes    String? // GP notes on the close

  // Relations
  investments Investment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fundId, closeNumber])
  // @@index([fundId]) — REMOVED: redundant, covered by @@unique([fundId, closeNumber]) and @@index([fundId, status])
  @@index([status])
  @@index([fundId, status])
}

enum FundCloseStatus {
  OPEN
  CLOSED
  FINAL
}

model Distribution {
  id     String @id @default(cuid())
  fundId String
  fund   Fund   @relation(fields: [fundId], references: [id], onDelete: Restrict)

  distributionNumber Int
  totalAmount        Decimal            @db.Decimal(18, 2)
  distributionType   DistributionType   @default(DIVIDEND)
  distributionDate   DateTime
  status             DistributionStatus @default(DRAFT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fundId])
  @@index([status])
}

enum DistributionStatus {
  DRAFT
  PENDING
  APPROVED
  PROCESSING
  DISTRIBUTED
  CANCELLED
  COMPLETED
}

enum DistributionType {
  DIVIDEND
  RETURN_OF_CAPITAL
  INTEREST
  OTHER
}

model FundReport {
  id     String @id @default(cuid())
  fundId String
  fund   Fund   @relation(fields: [fundId], references: [id], onDelete: Restrict)

  reportType   String
  reportPeriod String
  title        String
  fileUrl      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fundId])
}

model Subscription {
  id                  String  @id @default(cuid())
  investorId          String
  fundId              String?
  fund                Fund?   @relation(fields: [fundId], references: [id], onDelete: SetNull)
  signatureDocumentId String  @unique

  amount        Decimal          @db.Decimal(18, 2)
  units         Int?
  pricingTierId String?
  pricingTier   FundPricingTier? @relation(fields: [pricingTierId], references: [id], onDelete: SetNull)
  tierBreakdown Json?
  status        SubscriptionStatus @default(PENDING)

  signedAt  DateTime?
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([investorId])
  // @@index([fundId]) — REMOVED: redundant, covered by @@index([fundId, status, amount])
  @@index([signatureDocumentId])
  @@index([status])
  @@index([pricingTierId])
  // @@index([fundId, status]) — REMOVED: redundant, prefix of @@index([fundId, status, amount])
  @@index([fundId, status, amount]) // Composite index for AUM calculations (also covers capital tracking aggregates)
}

model FundPricingTier {
  id     String @id @default(cuid())
  fundId String
  fund   Fund   @relation(fields: [fundId], references: [id], onDelete: Restrict)

  tranche        Int
  name           String? // Display name: "Early Investor", "Growth", etc.
  pricePerUnit   Decimal @db.Decimal(18, 2)
  unitsAvailable Int
  unitsTotal     Int

  isActive Boolean @default(true)

  subscriptions Subscription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fundId, tranche])
  // @@index([fundId]) — REMOVED: redundant, covered by @@unique([fundId, tranche])
  @@index([isActive])
}

// --- Startup Mode: Funding Rounds (Pre-Seed, Seed, Series A, etc.) ---
// Tracks historical, active, and planned funding rounds for startups.
// Fund mode (GP_LP_FUND) uses FundPricingTier for tranche configuration;
// Startup mode uses FundingRound for round-based fundraising.
model FundingRound {
  id     String @id @default(cuid())
  fundId String
  fund   Fund   @relation(fields: [fundId], references: [id], onDelete: Restrict)

  roundName    String // "Pre-Seed", "Seed", "Series A", etc.
  roundOrder   Int // 1, 2, 3... for display ordering
  amountRaised Decimal @default(0) @db.Decimal(15, 2)
  targetAmount Decimal? @db.Decimal(15, 2) // null if completed externally

  preMoneyVal  Decimal? @db.Decimal(15, 2)
  postMoneyVal Decimal? @db.Decimal(15, 2)

  leadInvestor  String?
  investorCount Int     @default(0)
  roundDate     DateTime? // Date the round opened / was announced
  closeDate     DateTime? // Date the round closed (null if still open / planned)

  status     RoundStatus @default(PLANNED)
  isExternal Boolean     @default(false) // true = raised before FundRoom
  externalNotes String?  // GP notes about pre-FundRoom rounds

  instrumentType String? // "SAFE", "Convertible Note", "Priced Round"
  valuationCap   Decimal? @db.Decimal(15, 2)
  discount       Decimal? @db.Decimal(5, 2) // e.g. 20.00 = 20%

  orgId String // denormalized for multi-tenant isolation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fundId])
  @@index([orgId])
  @@index([fundId, status])
}

enum RoundStatus {
  COMPLETED
  ACTIVE
  PLANNED
}

model InvestorNote {
  id         String   @id @default(cuid())
  investorId String
  investor   Investor @relation(fields: [investorId], references: [id], onDelete: Restrict)
  teamId     String
  team       Team     @relation(fields: [teamId], references: [id], onDelete: Restrict)

  content        String  @db.Text
  isFromInvestor Boolean @default(true)

  createdAt DateTime @default(now())

  @@index([investorId])
  @@index([teamId])
}

// Plaid Bank Account Link
model BankLink {
  id         String   @id @default(cuid())
  investorId String
  investor   Investor @relation(fields: [investorId], references: [id], onDelete: Restrict)

  // Plaid tokens and identifiers
  plaidItemId      String @unique
  plaidAccessToken String // Encrypted access token
  plaidAccountId   String // Selected account ID

  // Account details (cached from Plaid)
  institutionId   String?
  institutionName String?
  accountName     String?
  accountMask     String? // Last 4 digits
  accountType     String? // checking, savings
  accountSubtype  String?

  // Status
  status       BankLinkStatus @default(ACTIVE)
  errorCode    String?
  errorMessage String?
  lastSyncAt   DateTime?

  // Plaid Transfer authorization
  transferEnabled Boolean @default(false)
  processorToken  String? // For ACH transfers

  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([investorId])
  @@index([status])
}

enum BankLinkStatus {
  ACTIVE
  PENDING_VERIFICATION
  DISCONNECTED
  ERROR
}

// Transaction records for capital calls and distributions
model Transaction {
  id         String    @id @default(cuid())
  investorId String
  investor   Investor  @relation(fields: [investorId], references: [id], onDelete: Restrict)
  bankLinkId String?
  bankLink   BankLink? @relation(fields: [bankLinkId], references: [id], onDelete: SetNull)

  // Transaction details
  type        TransactionType // CAPITAL_CALL, DISTRIBUTION
  amount      Decimal         @db.Decimal(18, 2)
  currency    String          @default("USD")
  description String?

  // Related records
  capitalCallId  String?
  distributionId String?
  fundId         String?
  fund           Fund?   @relation(fields: [fundId], references: [id], onDelete: Restrict)

  // Payment method (Phase 2: Stripe ACH integration)
  paymentMethod         PaymentMethodType? // How funds were transferred
  stripePaymentIntentId String? // Stripe PaymentIntent ID (Phase 2: ACH Direct Debit)

  // Plaid Transfer details
  plaidTransferId String? @unique
  transferType    String? // ach_debit, ach_credit

  // Status tracking
  status        TransactionStatus @default(PENDING)
  statusMessage String?

  // Timestamps
  initiatedAt DateTime  @default(now())
  processedAt DateTime?
  completedAt DateTime?
  failedAt    DateTime?

  // GP Receipt Confirmation (wire confirmation workflow)
  fundsReceivedDate           DateTime?
  fundsClearedDate            DateTime?
  // NAMING INCONSISTENCY: `confirmedBy` is a plain String storing userId without FK constraint.
  // Best-practice pattern uses `confirmedByUserId String` + `confirmedBy User @relation(...)`.
  // Phase 2: Rename to `confirmedByUserId`, add User @relation for referential integrity.
  confirmedBy                 String?
  confirmedAt                 DateTime?
  confirmationMethod          String? // MANUAL, BANK_API, PLAID
  bankReference               String? // Bank transaction reference number
  confirmationNotes           String?   @db.Text
  confirmationProofDocumentId String? // Storage key for optional bank statement upload
  expectedAmount              Decimal?  @db.Decimal(18, 2)
  amountVariance              Decimal?  @db.Decimal(18, 2)
  varianceNotes               String?

  // Audit trail (506(c) compliance)
  ipAddress   String?
  userAgent   String?
  // NAMING INCONSISTENCY: `initiatedBy` is a plain String storing userId without FK constraint.
  // Phase 2: Rename to `initiatedByUserId`, add User @relation for referential integrity.
  initiatedBy String?
  auditTrail  Json?
  metadata    Json? // Additional transaction metadata (e.g., subscriptionId)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // @@index([investorId]) — REMOVED: redundant, covered by @@index([investorId, type, status])
  @@index([bankLinkId])
  @@index([status])
  @@index([type])
  @@index([plaidTransferId])
  @@index([fundId]) // Standalone fundId for simple fund-scoped queries (composites have different 2nd cols: status vs type)
  @@index([fundId, status, type]) // Composite index for AUM calculations by fund
  @@index([fundId, type, completedAt]) // Composite index for time-based AUM reporting
  @@index([investorId, type, status]) // Composite index for investor transaction summaries
  @@index([confirmedBy])
}

// Manual Investment Entry - For tracking off-platform investments
model ManualInvestment {
  id         String   @id @default(cuid())
  investorId String
  investor   Investor @relation(fields: [investorId], references: [id], onDelete: Restrict)
  fundId     String
  fund       Fund     @relation(fields: [fundId], references: [id], onDelete: Restrict)
  teamId     String
  team       Team     @relation(fields: [teamId], references: [id], onDelete: Restrict)

  // Investment Details
  documentType   String // SUBSCRIPTION, LPA, SIDE_LETTER, OTHER
  documentTitle  String
  documentNumber String? // External reference number

  // Financial Details
  commitmentAmount Decimal  @db.Decimal(18, 2)
  fundedAmount     Decimal  @default(0) @db.Decimal(18, 2)
  unfundedAmount   Decimal? @db.Decimal(18, 2) // Calculated or manual
  units            Decimal? @db.Decimal(18, 4)
  shares           Decimal? @db.Decimal(18, 4)
  pricePerUnit     Decimal? @db.Decimal(18, 4)
  ownershipPercent Decimal? @db.Decimal(8, 4) // Percentage with 4 decimal places

  // Dates
  signedDate    DateTime
  effectiveDate DateTime?
  fundedDate    DateTime?
  maturityDate  DateTime?

  // Transfer Details
  transferMethod TransferMethod?
  transferStatus ManualInvestmentTransferStatus @default(NOT_INITIATED)
  transferDate   DateTime?
  transferRef    String? // Bank reference or transaction ID
  bankName       String?
  accountLast4   String?

  // Document Storage
  documentFile String? // Path to uploaded document
  storageType  DocumentStorageType @default(S3_PATH)

  // Status
  status     ManualInvestmentStatus @default(DRAFT)
  isVerified Boolean                @default(false) // GP has verified the document
  verifiedBy String?
  verifiedAt DateTime?

  // Proof of Payment (Manual Wire MVP)
  proofStatus          ManualInvestmentProofStatus @default(NOT_UPLOADED)
  proofDocumentKey     String? // Storage key for proof document
  proofStorageType     DocumentStorageType?
  proofFileType        String? // mime type
  proofFileName        String? // Original file name
  proofFileSize        Int?
  proofUploadedBy      String? // userId who uploaded proof
  proofUploadedAt      DateTime?
  proofVerifiedBy      String? // GP userId who verified
  proofVerifiedAt      DateTime?
  proofRejectedBy      String? // GP userId who rejected
  proofRejectedAt      DateTime?
  proofRejectionReason String?
  proofNotes           String?                     @db.Text // Notes from LP when uploading proof

  // Notes and Audit
  notes      String? @db.Text
  addedBy    String // userId who added the entry
  auditTrail Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // @@index([investorId]) — REMOVED: redundant, covered by @@index([investorId, fundId])
  // @@index([fundId]) — REMOVED: redundant, covered by @@index([fundId, status])
  @@index([teamId])
  @@index([status])
  @@index([proofStatus])
  @@index([signedDate])
  @@index([fundId, status]) // For fund-level aggregations
  @@index([fundId, transferStatus]) // For payment tracking queries
  @@index([investorId, fundId]) // For investor-fund lookups
}

enum ManualInvestmentStatus {
  DRAFT
  ACTIVE
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
}

enum ManualInvestmentTransferStatus {
  NOT_INITIATED
  PENDING
  COMPLETED
  FAILED
}

enum TransferMethod {
  WIRE
  ACH
  CHECK
  CRYPTO
  OTHER
}

enum ManualInvestmentProofStatus {
  NOT_UPLOADED
  UPLOADED
  VERIFIED
  REJECTED
  RECEIVED
  PENDING
  NOT_REQUIRED
}

// --- From signature.prisma ---
// E-Signature Platform Models
// FundRoom Sign - Company-wide document signing platform

model SignatureDocument {
  id          String                  @id @default(cuid())
  title       String
  description String?
  file        String // Reference to the PDF file in storage
  storageType DocumentStorageType     @default(S3_PATH)
  numPages    Int?
  status      SignatureDocumentStatus @default(DRAFT)

  // Expiration and tracking
  expirationDate DateTime?
  sentAt         DateTime?
  completedAt    DateTime?
  declinedAt     DateTime?
  voidedAt       DateTime?
  voidedReason   String?

  // Signing mode — controls how recipients are processed
  signingMode SigningMode @default(SEQUENTIAL) // SEQUENTIAL: one at a time by signingOrder. PARALLEL: all at once. MIXED: groups sign in parallel, groups are sequential

  // Message sent to recipients
  emailSubject String?
  emailMessage String?

  // Audit trail
  auditTrail Json? // Store complete audit trail

  // Completion Certificate
  certificateFile        String? // Reference to certificate PDF in storage
  certificateHash        String? // SHA-256 hash for verification
  certificateId          String? // Unique certificate identifier
  certificateGeneratedAt DateTime? // When certificate was generated

  // Subscription/investment metadata
  documentType       String? // "SUBSCRIPTION", "K1", "SIDE_LETTER", etc.
  subscriptionAmount Decimal? @db.Decimal(15, 2) // For subscription agreements
  metadata           Json? // Additional metadata (fund info, etc.)
  investorId         String? // Link to investor for LP documents

  // Signed/flattened PDF output
  signedFileUrl  String? // URL/key of the flattened signed PDF in storage
  signedFileType String? // Storage type: "S3_PATH", "VERCEL_BLOB", etc.
  signedAt       DateTime? // When the final signature was applied and PDF was flattened

  // Fund association — links document to a specific fund for LP onboarding
  fundId                String?
  fund                  Fund?   @relation(fields: [fundId], references: [id], onDelete: Restrict)
  requiredForOnboarding Boolean @default(false) // If true, LP must sign before proceeding

  // Relations
  teamId      String
  team        Team   @relation(fields: [teamId], references: [id], onDelete: Restrict)
  createdById String
  owner       User   @relation("SignatureDocumentOwner", fields: [createdById], references: [id], onDelete: Restrict)

  recipients SignatureRecipient[]
  fields     SignatureField[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // @@index([teamId]) — REMOVED: redundant, covered by @@index([teamId, status])
  @@index([status])
  @@index([createdById])
  @@index([teamId, status])
  @@index([fundId])
  @@index([investorId])
}

enum SignatureDocumentStatus {
  DRAFT // Document created but not sent
  SENT // Sent to recipients
  VIEWED // At least one recipient viewed
  PARTIALLY_SIGNED // Some but not all recipients signed
  COMPLETED // All recipients signed
  DECLINED // A recipient declined to sign
  VOIDED // Sender cancelled the document
  EXPIRED // Document expired before completion
}

model SignatureRecipient {
  id         String            @id @default(cuid())
  documentId String
  document   SignatureDocument @relation(fields: [documentId], references: [id], onDelete: Restrict)

  name         String
  email        String
  role         SignatureRecipientRole @default(SIGNER)
  signingOrder Int                    @default(1) // For sequential signing

  // Status tracking
  status         SignatureRecipientStatus @default(PENDING)
  viewedAt       DateTime?
  signedAt       DateTime?
  declinedAt     DateTime?
  declinedReason String?

  // Security & verification
  signingToken String? @unique // Secure token for signing URL
  accessCode   String? // Optional access code for additional security
  ipAddress    String? // IP address when signed
  userAgent    String? // Browser info when signed

  signingUrl String? // URL for recipient to sign

  // ESIGN/UETA Compliance
  consentRecord     Json? // ESIGN consent capture (timestamp, version, text)
  signatureChecksum Json? // Verification checksum (documentHash, signatureHash, token)

  // The actual signature data
  signatureImage String? // Base64 or URL to signature image

  // Reminder tracking
  lastReminderSentAt DateTime? // When the last reminder email was sent
  reminderCount      Int       @default(0) // Number of reminders sent

  fields SignatureField[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // @@index([documentId]) — REMOVED: redundant, covered by @@index([documentId, signingOrder])
  // @@index([email]) — REMOVED: redundant, covered by @@index([email, status])
  @@index([documentId, signingOrder])
  @@index([email, status])
}

enum SignatureRecipientRole {
  SIGNER // Must sign the document
  VIEWER // Only needs to view (CC)
  APPROVER // Must approve before others can sign
}

enum SignatureRecipientStatus {
  PENDING // Waiting for previous signers or not yet sent
  SENT // Email sent, waiting for action
  VIEWED // Recipient opened the document
  SIGNED // Recipient completed signing
  DECLINED // Recipient declined to sign
}

model SignatureField {
  id          String              @id @default(cuid())
  documentId  String
  document    SignatureDocument   @relation(fields: [documentId], references: [id], onDelete: Restrict)
  recipientId String?
  recipient   SignatureRecipient? @relation(fields: [recipientId], references: [id], onDelete: Restrict)

  type SignatureFieldType

  // Position on document
  pageNumber Int
  x          Float // X position (percentage of page width)
  y          Float // Y position (percentage of page height)
  width      Float // Width (percentage of page width)
  height     Float // Height (percentage of page height)

  // Field configuration
  label       String?
  placeholder String?
  required    Boolean @default(true)
  options     Json? // For DROPDOWN: ["Option A", "Option B"]. For RADIO: ["Yes", "No"]. For FORMULA: { formula: "field1 + field2", fields: ["fieldId1", "fieldId2"] }
  groupId     String? // Groups radio buttons together. All radios with same groupId are mutually exclusive
  fieldFormat String? // For CURRENCY: "USD", "EUR", etc. For NUMERIC: "integer", "decimal", "percentage"
  minValue    Float? // For NUMERIC/CURRENCY: minimum allowed value
  maxValue    Float? // For NUMERIC/CURRENCY: maximum allowed value
  tabOrder    Int? // Tab order for guided signing (step-by-step field navigation)
  conditionalOn String? // Field ID that controls visibility. Field is hidden until conditionalOn field has a value

  // Filled value
  value    String? // The value after recipient fills it
  filledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // @@index([documentId]) — REMOVED: redundant, covered by @@index([documentId, pageNumber])
  @@index([recipientId])
  @@index([documentId, pageNumber])
}

enum SignatureFieldType {
  SIGNATURE // Hand-drawn signature
  INITIALS // Initials
  DATE_SIGNED // Auto-filled date
  TEXT // Free text input
  CHECKBOX // Checkbox
  NAME // Auto-filled name
  EMAIL // Auto-filled email
  COMPANY // Company name
  TITLE // Job title
  ADDRESS // Mailing/physical address
  // New field types for e-signature feature parity (Feb 20, 2026)
  DROPDOWN // Dropdown select with predefined options (stored in SignatureField.options Json)
  RADIO // Radio button group (stored in SignatureField.options Json)
  NUMERIC // Numeric input (integer or decimal)
  CURRENCY // Currency input with formatting (USD, EUR, etc.)
  ATTACHMENT // File attachment request (signer uploads a file)
  FORMULA // Auto-calculated from other fields (formula in SignatureField.options Json)
}

// Signature Templates for reusable documents
model SignatureTemplate {
  id          String              @id @default(cuid())
  name        String
  description String?
  file        String // Reference to the template PDF
  storageType DocumentStorageType @default(S3_PATH)
  numPages    Int?

  // Default recipients (roles, not specific people)
  defaultRecipients Json? // Array of recipient placeholders

  // Pre-configured fields
  fields Json? // Array of field configurations

  // Default settings
  defaultEmailSubject   String?
  defaultEmailMessage   String?
  defaultExpirationDays Int?

  // Usage tracking
  usageCount Int @default(0)

  teamId      String
  team        Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  // NAMING INCONSISTENCY: `createdById` has the correct naming convention but lacks a User @relation.
  // Phase 2: Add `createdBy User @relation(...)` for referential integrity and type-safe queries.
  createdById String

  isPublic Boolean @default(false) // Available to all team members

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // @@index([teamId]) — REMOVED: redundant, covered by @@index([teamId, isPublic])
  @@index([teamId, isPublic])
}

// Document Templates — HTML templates with merge fields for LP signing flow.
// Tracks per-org template configurations with content (HTML string), version, and active status.
// Default templates ship with the platform (in /templates/ directory); GPs can upload custom HTML.
// Distinct from SignatureTemplate (PDF templates with field coordinates for FundRoom Sign).
model DocumentTemplate {
  id             String  @id @default(cuid())
  name           String // Display name (e.g., "NDA / Confidentiality Agreement")
  documentType   String // NDA, SUBSCRIPTION, LPA, PPM, SIDE_LETTER, etc.
  content        String  @db.Text // HTML template string with {{merge_field}} placeholders
  version        Int     @default(1)
  isActive       Boolean @default(true)
  isDefault      Boolean @default(false) // Platform default vs custom
  templateSource String  @default("PLATFORM") // PLATFORM | CUSTOM_UPLOAD

  // Organization scoping — null for platform defaults
  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Fund scoping — optional, for fund-specific template overrides
  fundId String?
  fund   Fund?   @relation("FundDocumentTemplates", fields: [fundId], references: [id], onDelete: SetNull)

  createdBy String? // userId who created/uploaded this template
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, documentType, fundId, isActive])
  @@index([teamId, documentType])
  @@index([documentType, isDefault])
}

// General audit log for system-wide events (not signature-specific)
// Supports immutable logging with cryptographic hash chaining for tamper detection
model AuditLog {
  id           String   @id @default(cuid())
  eventType    String
  userId       String?
  teamId       String?
  resourceType String?
  resourceId   String?
  ipAddress    String?
  userAgent    String?
  metadata     Json?
  createdAt    DateTime @default(now())

  // Immutable audit log fields for cryptographic chain verification
  previousHash   String? // SHA-256 hash of the previous entry (null for genesis)
  currentHash    String? // SHA-256 hash of this entry's data
  sequenceNumber BigInt? // Monotonically increasing sequence for ordering
  timestamp      DateTime? // Precise timestamp for hash computation
  metadataHash   String? // SHA-256 hash of canonicalized metadata for deterministic verification

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  team Team? @relation(fields: [teamId], references: [id], onDelete: Restrict)

  @@index([teamId])
  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@index([sequenceNumber])
  @@index([currentHash])
}

model SignatureAuditLog {
  id             String  @id @default(cuid())
  documentId     String
  event          String
  recipientId    String?
  recipientEmail String?
  ipAddress      String?
  userAgent      String?
  metadata       Json?

  // Extended tracking for compliance
  country        String?
  city           String?
  region         String?
  browser        String?
  browserVersion String?
  os             String?
  osVersion      String?
  device         String? @default("Desktop")
  deviceVendor   String?
  deviceModel    String?
  referer        String?

  // Session and action tracking
  sessionId      String?
  actionDuration Int? // Duration of action in milliseconds
  pageNumber     Int? // For document view events

  createdAt DateTime @default(now())

  // @@index([documentId]) — REMOVED: redundant, covered by @@index([documentId, event])
  @@index([event])
  @@index([documentId, event])
  @@index([createdAt])
  @@index([recipientEmail])
  @@index([ipAddress])
}

// --- From team.prisma ---
model Team {
  id   String @id @default(cuid())
  name String

  // Enterprise: Organization membership (optional for backwards compatibility)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // Override flags - when true, use team-level settings instead of org defaults
  overrideOrgDefaults Boolean       @default(false)
  teamDefaults        TeamDefaults?

  // Feature Flags (team-level overrides)
  featureFlags Json? // { "dataroom.enabled": true, ... }

  users        UserTeam[]
  documents    Document[]
  folders      Folder[]
  domains      Domain[]
  invitations  Invitation[]
  sentEmails   SentEmail[]
  brand        Brand?
  datarooms    Dataroom[]
  agreements   Agreement[]
  viewerGroups ViewerGroup[]
  viewers      Viewer[]

  permissionGroups  PermissionGroup[]
  linkPresets       LinkPreset[] // Link presets for the team
  incomingWebhooks  IncomingWebhook[]
  restrictedTokens  RestrictedToken[]
  webhooks          Webhook[]
  conversations     Conversation[]
  dataroomFaqItems  DataroomFaqItem[]
  uploadedDocuments DocumentUpload[]
  Tag               Tag[]
  annotations       DocumentAnnotation[] // Annotations created by team members

  installedIntegrations InstalledIntegration[]

  links     Link[]
  views     View[]
  workflows Workflow[]

  // E-Signature Platform
  signatureDocuments SignatureDocument[]
  signatureTemplates SignatureTemplate[]

  // Q&A System
  viewerNotes       ViewerNote[]
  dataroomQuestions DataroomQuestion[]

  // Access Requests
  accessRequests AccessRequest[]

  // LP Portal - Fund Management
  funds             Fund[]
  investorNotes     InvestorNote[]
  entities          Entity[]
  manualInvestments ManualInvestment[]

  // Audit logs
  auditLogs AuditLog[]

  // Advanced Reporting
  reportTemplates  ReportTemplate[]
  generatedReports GeneratedReport[]

  // Marketplace
  deals               Deal[]
  marketplaceListings MarketplaceListing[]

  // Fundroom Activation
  fundroomActivations FundroomActivation[]

  // Year In Review
  yearInReviews YearInReview[]

  // Premium Offering Pages
  offeringPages OfferingPage[]

  // CRM
  contacts         Contact[]
  esigUsageRecords EsigUsageRecord[]

  // E-Signature Platform & Shared Drive
  envelopes     Envelope[]
  contactVaults ContactVault[]

  // Document Templates (HTML with merge fields)
  documentTemplates DocumentTemplate[]

  plan           String    @default("datarooms-plus")
  stripeId       String?   @unique // Stripe customer ID
  subscriptionId String?   @unique // Stripe subscription ID
  startsAt       DateTime? // Stripe subscription start date
  endsAt         DateTime? // Stripe subscription end date
  pausedAt       DateTime? // When the subscription was paused
  pauseStartsAt  DateTime? // When the pause period starts
  pauseEndsAt    DateTime? // When the pause period ends
  cancelledAt    DateTime? // When the subscription was cancelled

  limits Json? // Plan limits // {datarooms: 1, users: 1, domains: 1, customDomainOnPro: boolean, customDomainInDataroom: boolean}

  // team settings
  enableExcelAdvancedMode       Boolean @default(false) // Enable Excel advanced mode for all documents in the team
  replicateDataroomFolders      Boolean @default(true) // Replicate dataroom folder structure in "All Documents"
  enableClientSideEncryption    Boolean @default(false) // Enable client-side encryption for sensitive document uploads
  requireEncryptionForSensitive Boolean @default(false) // Require encryption for documents marked as sensitive

  // AI agents
  agentsEnabled Boolean @default(false) // Enable AI agents for the team
  vectorStoreId String? // OpenAI vector store ID for team-level document search
  chats         Chat[]

  // Email Domain Configuration (multi-tenant Resend)
  emailDomainId         String? // Resend domain ID (returned from domains.create)
  emailDomain           String? // Verified sending domain (e.g. "mail.acmecapital.com")
  emailDomainStatus     String? // "not_started" | "pending" | "verified" | "failed" | "temporary_failure"
  emailDomainRegion     String?   @default("us-east-1") // Resend region
  emailFromName         String? // Display name for outbound emails (e.g. "Acme Capital")
  emailFromAddress      String? // Local part of from address (e.g. "notifications") → notifications@acmecapital.com
  emailReplyTo          String? // Optional reply-to override
  emailDomainVerifiedAt DateTime? // When the domain was verified
  emailDomainDnsRecords Json? // Cached DNS records from Resend (shown in setup wizard)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete timestamp

  ignoredDomains  String[] // Domains that are ignored for the team
  globalBlockList String[] // Email and domains that are blocked for the team

  @@index([deletedAt]) // Performance optimization for filtering deleted teams
  @@index([organizationId]) // Enterprise: filter teams by organization
}

// Team-level defaults (overrides org defaults when team.overrideOrgDefaults = true)
model TeamDefaults {
  id     String @id @default(cuid())
  teamId String @unique
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Restrict)

  // Dataroom Defaults
  dataroomConversationsEnabled      Boolean?
  dataroomAgentsEnabled             Boolean?
  dataroomAllowBulkDownload         Boolean?
  dataroomShowLastUpdated           Boolean?
  dataroomChangeNotifications       Boolean?
  dataroomDefaultPermissionStrategy DefaultPermissionStrategy?

  // Link Defaults
  linkEmailProtected      Boolean?
  linkEmailAuthenticated  Boolean?
  linkAllowDownload       Boolean?
  linkEnableNotifications Boolean?
  linkEnableWatermark     Boolean?
  linkExpirationDays      Int?
  linkPasswordRequired    Boolean?

  // Fundroom Defaults
  fundroomNdaGateEnabled           Boolean?
  fundroomKycRequired              Boolean?
  fundroomAccreditationRequired    Boolean?
  fundroomStagedCommitmentsEnabled Boolean?
  fundroomCallFrequency            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Role {
  OWNER
  SUPER_ADMIN
  ADMIN
  MANAGER
  MEMBER
}

model UserTeam {
  role   Role   @default(MEMBER)
  status UserTeamStatus @default(ACTIVE)
  userId String
  teamId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  blockedAt               DateTime? // When the user was blocked
  notificationPreferences Json? // Format: { yearInReview: { "enabled": false } }
  hasFundroomAccess       Boolean   @default(true) // Whether user can access the fundroom

  /// CRM-specific role controlling pipeline access granularity.
  /// Defaults to null (inherits from team role: OWNER/ADMIN/SUPER_ADMIN → MANAGER,
  /// MANAGER → CONTRIBUTOR, MEMBER → VIEWER).
  /// Explicitly set via Settings > Team Management.
  /// - VIEWER: Can see pipeline, contact details, activity history. Cannot send emails or modify contacts.
  /// - CONTRIBUTOR: Can add contacts, update notes, set follow-up reminders. Cannot send outreach emails.
  /// - MANAGER: Full CRM access. Can send emails, manage sequences, approve AI drafts, configure settings.
  crmRole CrmRole?

  @@id([userId, teamId])
  @@index([userId])
  @@index([teamId])
}

// --- From dataroom.prisma ---
model Dataroom {
  id           String             @id @default(cuid())
  pId          String             @unique // This is the generated public ID for the dataroom dr_1234
  name         String
  description  String?
  teamId       String
  team         Team               @relation(fields: [teamId], references: [id], onDelete: Cascade)
  documents    DataroomDocument[]
  folders      DataroomFolder[]
  links        Link[]
  views        View[]
  viewers      Viewer[]
  viewerGroups ViewerGroup[]
  brand        DataroomBrand?

  permissionGroups PermissionGroup[]

  // conversation
  conversationsEnabled Boolean        @default(false)
  conversations        Conversation[]

  // FAQ system
  faqItems DataroomFaqItem[]

  // AI agents
  agentsEnabled Boolean @default(false) // Enable AI agents for this dataroom
  vectorStoreId String? // OpenAI vector store ID for AI search
  chats         Chat[]

  // upload external documents
  uploadedDocuments DocumentUpload[]

  // tags
  tags TagItem[]

  // Q&A System
  viewerNotes       ViewerNote[]
  dataroomQuestions DataroomQuestion[]

  // notification settings
  enableChangeNotifications Boolean @default(false)

  // unified permission strategy
  defaultPermissionStrategy DefaultPermissionStrategy @default(INHERIT_FROM_PARENT)

  // bulk download setting
  allowBulkDownload Boolean @default(true) // Allow bulk download of entire dataroom

  // display settings
  showLastUpdated Boolean @default(true) // Show/hide last updated date in dataroom view

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete timestamp

  @@index([teamId])
  @@index([deletedAt]) // Performance optimization for filtering deleted datarooms
}

model DataroomDocument {
  id                String          @id @default(cuid())
  dataroomId        String
  dataroom          Dataroom        @relation(fields: [dataroomId], references: [id], onDelete: Cascade)
  documentId        String
  document          Document        @relation(fields: [documentId], references: [id], onDelete: Cascade)
  folderId          String?
  folder            DataroomFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  orderIndex        Int?
  hierarchicalIndex String? // Computed field like "1.2.3" for hierarchical display

  conversations Conversation[]

  // FAQ system
  dataroomFAQs DataroomFaqItem[]

  uploadedDocuments DocumentUpload[]

  vectorStoreFileId String? // vector store file ID for AI search

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([dataroomId, documentId])
  @@index([folderId])
  @@index([dataroomId, folderId, orderIndex])
  @@index([documentId])
}

model DataroomFolder {
  id                String             @id @default(cuid())
  name              String
  path              String // the materialized path to the folder; starts always with "/"
  parentId          String?
  documents         DataroomDocument[]
  childFolders      DataroomFolder[]   @relation("SubFolders")
  parentFolder      DataroomFolder?    @relation("SubFolders", fields: [parentId], references: [id], onDelete: SetNull)
  dataroomId        String
  dataroom          Dataroom           @relation(fields: [dataroomId], references: [id], onDelete: Cascade)
  orderIndex        Int?
  hierarchicalIndex String? // Computed field like "1.2" for hierarchical display

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([dataroomId, path])
  @@index([parentId])
  @@index([dataroomId, parentId, orderIndex])
}

model DataroomBrand {
  id             String   @id @default(cuid())
  logo           String? // This should be a reference to where the file is stored (S3, Google Cloud Storage, etc.)
  banner         String? // This should be a reference to where the file is stored (S3, Google Cloud Storage, etc.)
  favicon        String? // Custom favicon for the dataroom visitor portal
  brandColor     String? // This should be a reference to the brand color
  accentColor    String? // This should be a reference to the accent color
  welcomeMessage String? // This should be a reference to the welcome message
  dataroomId     String   @unique
  dataroom       Dataroom @relation(fields: [dataroomId], references: [id], onDelete: Cascade)

  // Welcome splash screen settings
  welcomeScreenEnabled    Boolean @default(false) // Show splash screen on entry
  welcomePersonalNote     String? // Personal note from the admin
  welcomeSuggestedViewing String? // Suggested viewing paragraph(s)
  welcomeRecommendedDocs  Json? // Array of document IDs to recommend viewing first

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ViewerGroup {
  id             String                      @id @default(cuid())
  name           String
  members        ViewerGroupMembership[]
  domains        String[]
  links          Link[]
  accessControls ViewerGroupAccessControls[]
  allowAll       Boolean                     @default(false)
  isQuickAdd     Boolean                     @default(false) // Quick Add group for one-click access

  dataroomId String
  dataroom   Dataroom @relation(fields: [dataroomId], references: [id], onDelete: Cascade)
  teamId     String
  team       Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  views         View[]
  conversations Conversation[]
  invitations   ViewerInvitation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // @@index([dataroomId]) — REMOVED: redundant, covered by @@index([dataroomId, createdAt])
  @@index([teamId])
  @@index([dataroomId, createdAt])
  @@index([dataroomId, isQuickAdd])
}

model ViewerGroupMembership {
  id       String      @id @default(cuid())
  viewerId String
  viewer   Viewer      @relation(fields: [viewerId], references: [id], onDelete: Cascade)
  groupId  String
  group    ViewerGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([viewerId, groupId])
  @@index([viewerId])
  @@index([groupId])
}

model ViewerGroupAccessControls {
  id      String      @id @default(cuid())
  groupId String
  group   ViewerGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  // Access control for items (documents or dataroom items)
  itemId   String // This can be a document ID or a dataroom item ID
  itemType ItemType // Enum: DATAROOM_DOCUMENT, DATAROOM_FOLDER

  // Granular permissions
  canView     Boolean @default(true)
  canDownload Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([groupId, itemId])
  @@index([groupId])
}

enum ItemType {
  DATAROOM_DOCUMENT
  DATAROOM_FOLDER
}

enum DefaultPermissionStrategy {
  INHERIT_FROM_PARENT
  ASK_EVERY_TIME
  HIDDEN_BY_DEFAULT
}

model PermissionGroup {
  id          String  @id @default(cuid())
  name        String
  description String?

  links          Link[]
  accessControls PermissionGroupAccessControls[]

  dataroomId String
  dataroom   Dataroom @relation(fields: [dataroomId], references: [id], onDelete: Cascade)
  teamId     String
  team       Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dataroomId])
  @@index([teamId])
}

model PermissionGroupAccessControls {
  id      String          @id @default(cuid())
  groupId String
  group   PermissionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  // Access control for items (documents or dataroom items)
  itemId   String // This can be a document ID or a dataroom item ID
  itemType ItemType // Enum: DATAROOM_DOCUMENT, DATAROOM_FOLDER

  // Granular permissions
  canView             Boolean @default(true)
  canDownload         Boolean @default(false)
  canDownloadOriginal Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([groupId, itemId])
  @@index([groupId])
}

// --- From document.prisma ---
model Document {
  id                   String              @id @default(cuid())
  name                 String
  description          String?
  file                 String // This should be a reference to where the file is stored (S3, Google Cloud Storage, etc.)
  originalFile         String? // This should be a reference to the original file like pptx, xlsx, etc. (S3, Google Cloud Storage, etc.)
  type                 String? // This should be a reference to the file type (pdf, sheet, etc.)
  contentType          String? // This should be the actual contentType of the file like application/pdf, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, etc.
  storageType          DocumentStorageType @default(VERCEL_BLOB)
  numPages             Int? // This should be a reference to the number of pages in the document
  owner                User?               @relation(fields: [ownerId], references: [id], onDelete: SetNull)
  teamId               String
  team                 Team                @relation(fields: [teamId], references: [id], onDelete: Cascade)
  ownerId              String? // This field holds the foreign key.
  assistantEnabled     Boolean             @default(false) // This indicates if assistant is enabled for this document
  advancedExcelEnabled Boolean             @default(false) // This indicates if advanced Excel is enabled for this document
  agentsEnabled        Boolean             @default(false) // This indicates if AI agents are enabled for this document
  downloadOnly         Boolean             @default(false) // Indicates if the document is download only
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  links                Link[]
  views                View[]
  versions             DocumentVersion[]
  chats                Chat[]

  folderId String? // Optional Folder ID for documents in folders
  folder   Folder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  datarooms   DataroomDocument[] // Datarooms associated with this document
  tags        TagItem[]
  annotations DocumentAnnotation[] // Annotations for this document

  // upload external documents
  uploadedDocument DocumentUpload[]
  isExternalUpload Boolean          @default(false) // Indicates if the document is an external upload

  // Q&A System
  viewerNotes       ViewerNote[]
  dataroomQuestions DataroomQuestion[]

  // Client-side encryption metadata
  isClientEncrypted Boolean @default(false) // Indicates if file was encrypted client-side before upload
  encryptionKeyHash String? // Hash of encryption key for verification (NOT the key itself)
  encryptionIv      String? // Initialization vector used for encryption
  originalFileName  String? // Original filename before encryption
  originalFileSize  BigInt? // Original file size before encryption

  deletedAt DateTime? // Soft delete timestamp

  @@index([ownerId])
  // @@index([teamId]) — REMOVED: redundant, covered by @@index([teamId, folderId])
  @@index([type]) // Filter documents by file type (pdf, sheet, etc.)
  @@index([folderId])
  @@index([deletedAt]) // Performance optimization for filtering deleted documents
  @@index([teamId, folderId]) // Performance optimization for document filtering by team and folder
  @@index([teamId, name]) // Performance optimization for document search by name
}

model DocumentVersion {
  id                String              @id @default(cuid())
  versionNumber     Int // e.g., 1, 2, 3 for version control
  document          Document            @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId        String
  file              String // This should be a reference to where the file is stored (S3, Google Cloud Storage, etc.)
  originalFile      String? // This should be a reference to the original file like pptx, xlsx, etc. (S3, Google Cloud Storage, etc.)
  type              String? // This should be a reference to the file type (pdf, docx, etc.)
  contentType       String? // This should be the actual contentType of the file like application/pdf, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, etc.
  fileSize          BigInt? // This should be the size of the file in bytes
  storageType       DocumentStorageType @default(VERCEL_BLOB)
  numPages          Int? // This should be a reference to the number of pages in the document
  isPrimary         Boolean             @default(false) // Indicates if this is the primary version
  isVertical        Boolean             @default(false) // Indicates if the document is vertical (portrait) or not (landscape)
  fileId            String? // This is the file ID of the OpenAI File API
  vectorStoreFileId String? // OpenAI vector store file ID for AI search
  pages             DocumentPage[]
  hasPages          Boolean             @default(false) // Indicates if the document has pages
  length            Int? // This is the length of the video in seconds
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@unique([versionNumber, documentId])
  // @@index([documentId]) — REMOVED: redundant, covered by @@index([documentId, isPrimary, createdAt])
  // @@index([documentId, isPrimary]) — REMOVED: redundant, prefix of @@index([documentId, isPrimary, createdAt])
  @@index([documentId, createdAt(sort: Desc)]) // Kept: sort-order-specific, not covered by other composites
  @@index([documentId, isPrimary, createdAt]) // Optimize primary version lookups with ordering (also covers documentId and documentId+isPrimary prefix scans)
}

model DocumentPage {
  id            String              @id @default(cuid())
  version       DocumentVersion     @relation(fields: [versionId], references: [id], onDelete: Cascade)
  versionId     String
  pageNumber    Int // e.g., 1, 2, 3 for 
  embeddedLinks String[]
  pageLinks     Json? // This will store the page links data: [{href: "https://example.com", coords: "0,0,100,100"}]
  metadata      Json? // This will store the page metadata: {originalWidth: 100, origianlHeight: 100, scaledWidth: 50, scaledHeight: 50, scaleFactor: 2}
  file          String // This should be a reference to where the file / page is stored (S3, Google Cloud Storage, etc.)
  storageType   DocumentStorageType @default(VERCEL_BLOB)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@unique([pageNumber, versionId])
  @@index([versionId])
}

enum DocumentStorageType {
  S3_PATH
  VERCEL_BLOB
  REPLIT
  ENCRYPTED
}

model Folder {
  id           String     @id @default(cuid())
  name         String
  path         String // the materialized path to the folder; starts always with "/"
  parentId     String?
  documents    Document[]
  childFolders Folder[]   @relation("SubFolders")
  parentFolder Folder?    @relation("SubFolders", fields: [parentId], references: [id], onDelete: SetNull)
  teamId       String
  team         Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Note: @@index([teamId]) not needed — @@unique([teamId, path]) covers teamId prefix lookups

  @@unique([teamId, path])
  @@index([parentId])
}

model DocumentUpload {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  teamId     String
  team       Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  viewerId   String?
  viewer     Viewer?  @relation(fields: [viewerId], references: [id], onDelete: SetNull)
  viewId     String?
  view       View?    @relation(fields: [viewId], references: [id], onDelete: SetNull)
  linkId     String
  link       Link     @relation(fields: [linkId], references: [id], onDelete: Cascade)

  // Optional dataroom relations
  dataroomId         String?
  dataroom           Dataroom?         @relation(fields: [dataroomId], references: [id], onDelete: SetNull)
  dataroomDocumentId String?
  dataroomDocument   DataroomDocument? @relation(fields: [dataroomDocumentId], references: [id], onDelete: SetNull)

  // Additional metadata
  originalFilename String?
  fileSize         BigInt?
  numPages         Int?
  mimeType         String?
  uploadedAt       DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([documentId])
  @@index([viewerId])
  @@index([viewId])
  @@index([linkId])
  @@index([teamId])
  @@index([dataroomId])
  @@index([dataroomDocumentId])
}

// --- From link.prisma ---
enum LinkType {
  DOCUMENT_LINK
  DATAROOM_LINK
  WORKFLOW_LINK
}

enum LinkAudienceType {
  GENERAL
  GROUP
  TEAM
}

model Link {
  id                         String     @id @default(cuid())
  document                   Document?  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId                 String? // This can be nullable, representing links without documents
  dataroom                   Dataroom?  @relation(fields: [dataroomId], references: [id], onDelete: Cascade)
  dataroomId                 String? // This can be nullable, representing links without datarooms
  linkType                   LinkType   @default(DOCUMENT_LINK) // This will store the type of the link
  url                        String?    @unique
  name                       String? // Link name
  slug                       String? // Link slug for pretty URLs
  expiresAt                  DateTime? // Optional expiration date
  password                   String? // Optional password for link protection
  allowList                  String[] // Array of emails and domains allowed to view the document
  denyList                   String[] // Array of emails and domains denied to view the document
  emailProtected             Boolean    @default(true) // Optional email protection
  emailAuthenticated         Boolean    @default(true) // When true: requires OTP verification (6-digit code) for access. Default ON for launch security.
  allowDownload              Boolean?   @default(false) // Optional give user a option to allow to download the document
  isArchived                 Boolean    @default(false) // Indicates if the link is archived
  deletedAt                  DateTime? // Soft delete timestamp
  views                      View[]
  domain                     Domain?    @relation(fields: [domainId], references: [id], onDelete: SetNull)
  domainId                   String? // This can be nullable, representing links without custom domains
  domainSlug                 String? // This will store the domain's slug even if the domain is deleted
  createdAt                  DateTime   @default(now())
  updatedAt                  DateTime   @updatedAt
  enableNotification         Boolean?   @default(true) // Optional give user a option to pause/resume the notifications
  enableFeedback             Boolean?   @default(false) // Optional give user a option to enable the reactions toolbar
  enableQuestion             Boolean?   @default(false) // Optional give user a option to enable the question feedback
  enableScreenshotProtection Boolean?   @default(false) // Optional give user a option to enable the screenshot protection
  feedback                   Feedback?
  enableAgreement            Boolean?   @default(false) // Optional give user a option to enable the terms and conditions
  agreement                  Agreement? @relation(fields: [agreementId], references: [id], onDelete: SetNull)
  agreementId                String? // This can be nullable, representing links without agreements

  // Self-accreditation gate — visitor must confirm accredited investor status before viewing
  enableAccreditation              Boolean?                  @default(false)
  accreditationType                AccreditationGateType?    @default(SELF_CERTIFICATION)
  accreditationMessage             String?                   // Custom message/disclaimer shown above checkboxes
  accreditationGateResponses       AccreditationGateResponse[]
  showBanner                 Boolean?   @default(false) // Optional give user a option to show the banner and end of document signup form
  enableWatermark            Boolean?   @default(false) // Optional give user a option to enable the watermark
  watermarkConfig            Json? // This will store the watermark configuration: {text: "Confidential", isTiled: false, color: "#000000", fontSize: 12, opacity: 0.5, rotation: 30, position: "top-right"}

  // group links
  audienceType LinkAudienceType @default(GENERAL) // This will store the audience type of the link
  groupId      String?
  group        ViewerGroup?     @relation(fields: [groupId], references: [id], onDelete: SetNull)

  // granular permissions
  permissionGroupId String?
  permissionGroup   PermissionGroup? @relation(fields: [permissionGroupId], references: [id], onDelete: SetNull)

  // custom metatags
  metaTitle           String? // This will be the meta title of the link
  metaDescription     String? // This will be the meta description of the link
  metaImage           String? // This will be the meta image of the link
  metaFavicon         String? // This will be the meta favicon of the link
  enableCustomMetatag Boolean? @default(false) // Optional give user a option to enable the custom metatag

  // custom welcome message (overrides brand welcome message)
  welcomeMessage String? // Custom welcome message for this specific link

  // conversation
  enableConversation Boolean        @default(false) // Controls if conversations are allowed on this link
  conversations      Conversation[]

  // FAQ system
  dataroomFaqItems DataroomFaqItem[]

  // AI chats
  enableAIAgents Boolean? @default(false) // Enable AI agents for this link
  chats          Chat[]

  // upload
  enableUpload      Boolean? @default(false) // Optional give user a option to enable the upload document function
  isFileRequestOnly Boolean? @default(false) // Optional give user a option to enable the file request only
  uploadFolderId    String? // This can be nullable, indicating upload to root folder, either document folder or dataroom folder
  enableIndexFile   Boolean? @default(false)

  uploadedDocuments DocumentUpload[]

  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  customFields CustomField[]

  tags              TagItem[]
  viewerInvitations ViewerInvitation[]

  // workflow entry link
  workflow Workflow?

  // Q&A System
  viewerNotes       ViewerNote[]
  dataroomQuestions DataroomQuestion[]

  // Access Requests
  accessRequests AccessRequest[]

  @@unique([domainSlug, slug])
  // @@index([documentId]) — REMOVED: redundant, covered by @@index([documentId, isArchived])
  // @@index([teamId]) — REMOVED: redundant, covered by @@index([teamId, expiresAt])
  @@index([teamId, expiresAt]) // Composite for expiring links cleanup queries per team (also covers standalone teamId prefix)
  @@index([documentId, isArchived]) // Performance optimization for active links filtering (also covers standalone documentId prefix)
  @@index([permissionGroupId]) // Performance optimization for permission group queries
  @@index([deletedAt]) // Performance optimization for filtering deleted links
}

model LinkPreset {
  id     String  @id @default(cuid())
  name   String
  teamId String
  team   Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  pId    String? @unique

  enableCustomMetaTag Boolean? @default(false) // Optional give user a option to enable the custom metatag
  metaTitle           String? // This will be the meta title of the link
  metaDescription     String? // This will be the meta description of the link
  metaImage           String? // This will be the meta image of the link 
  metaFavicon         String? // This will be the meta favicon of the link

  enableNotification         Boolean?  @default(false)
  emailProtected             Boolean?  @default(true)
  emailAuthenticated         Boolean?  @default(true)
  allowDownload              Boolean?  @default(false)
  enableAllowList            Boolean?  @default(false)
  allowList                  String[]
  enableDenyList             Boolean?  @default(false)
  denyList                   String[]
  expiresIn                  Int? // how many days from link creation until it expires in seconds
  enableScreenshotProtection Boolean?  @default(false)
  expiresAt                  DateTime?
  enablePassword             Boolean?  @default(false)
  password                   String?
  enableWatermark            Boolean?  @default(false)
  watermarkConfig            Json? //{text: "Confidential", isTiled: false, color: "#000000", fontSize: 12, opacity: 0.5, rotation: 30, position: "top-right"}

  enableAgreement Boolean? @default(false)
  agreementId     String?

  // Self-accreditation gate — mirrors Link model fields
  enableAccreditation  Boolean? @default(false)
  accreditationType    String?  // AccreditationGateType value stored as string in presets
  accreditationMessage String?

  enableCustomFields Boolean? @default(false)
  customFields       Json? //[{type: "SHORT_TEXT", identifier: "name", label: "Name", required: true}]

  showBanner Boolean? @default(false) // Optional give user a option to show the "Powered by FundRoom" banner

  welcomeMessage String? // Custom welcome message for links created from this preset

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
}

enum CustomFieldType {
  SHORT_TEXT
  LONG_TEXT
  NUMBER
  PHONE_NUMBER
  URL
  CHECKBOX
  SELECT
  MULTI_SELECT
}

model CustomField {
  id          String          @id @default(cuid())
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  type        CustomFieldType
  identifier  String
  label       String
  placeholder String?
  required    Boolean         @default(false)
  disabled    Boolean         @default(false)
  link        Link            @relation(fields: [linkId], references: [id], onDelete: Cascade)
  linkId      String
  orderIndex  Int             @default(0)

  @@index([linkId])
}

model CustomFieldResponse {
  id        String   @id @default(cuid())
  data      Json // Store the custom field responses as a JSON object [{ "identifier": "value", "label": "value", "response:" }]
  viewId    String   @unique
  view      View     @relation(fields: [viewId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([viewId])
}

enum AccessRequestStatus {
  PENDING
  APPROVED
  DENIED
}

model AccessRequest {
  id         String              @id @default(cuid())
  email      String
  name       String?
  message    String?
  status     AccessRequestStatus @default(PENDING)
  linkId     String
  link       Link                @relation(fields: [linkId], references: [id], onDelete: Cascade)
  dataroomId String?
  teamId     String
  team       Team                @relation(fields: [teamId], references: [id], onDelete: Cascade)
  // NAMING INCONSISTENCY: `reviewedBy` is a plain String storing userId without FK constraint.
  // Phase 2: Rename to `reviewedByUserId`, add User @relation for referential integrity.
  reviewedBy String?
  reviewedAt DateTime?
  denyReason String?
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  @@unique([linkId, email])
  @@index([linkId])
  @@index([teamId])
  @@index([status])
}

// --- From annotation.prisma ---
model DocumentAnnotation {
  id          String            @id @default(cuid())
  title       String
  content     Json // Rich text content stored as JSON (Tiptap/ProseMirror format)
  pages       Int[] // Array of page numbers this annotation applies to
  documentId  String
  document    Document          @relation(fields: [documentId], references: [id], onDelete: Cascade)
  teamId      String
  team        Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdById String
  createdBy   User              @relation(fields: [createdById], references: [id], onDelete: Cascade)
  isVisible   Boolean           @default(true) // Allow admin to hide/show annotations
  images      AnnotationImage[] // Images attached to this annotation
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([documentId])
  @@index([teamId])
  @@index([createdById])
}

model AnnotationImage {
  id           String             @id @default(cuid())
  filename     String
  url          String
  size         Int?
  mimeType     String?
  annotationId String
  annotation   DocumentAnnotation @relation(fields: [annotationId], references: [id], onDelete: Cascade)
  createdAt    DateTime           @default(now())

  @@index([annotationId])
}

// --- From conversation.prisma ---
model Conversation {
  id        String  @id @default(cuid())
  title     String? // Optional title for the conversation
  isEnabled Boolean @default(true)

  // Visibility control
  visibilityMode ConversationVisibility @default(PRIVATE)

  // Core relationships
  dataroomId String
  dataroom   Dataroom @relation(fields: [dataroomId], references: [id], onDelete: Cascade)

  // Optional attachments
  dataroomDocumentId    String?
  dataroomDocument      DataroomDocument? @relation(fields: [dataroomDocumentId], references: [id], onDelete: SetNull)
  documentVersionNumber Int? // Optional document version number reference
  documentPageNumber    Int? // Optional document page number reference

  // Optional link relationship
  linkId String?
  link   Link?   @relation(fields: [linkId], references: [id], onDelete: SetNull)

  // Optional viewer group relationship
  viewerGroupId String?
  viewerGroup   ViewerGroup? @relation(fields: [viewerGroupId], references: [id], onDelete: SetNull)

  // Original view that initiated the conversation (for reference)
  initialViewId String?
  initialView   View?   @relation(name: "initialView", fields: [initialViewId], references: [id], onDelete: SetNull)

  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Track all views that accessed this conversation
  views ConversationView[]

  // Track participants including the owner
  participants ConversationParticipant[]

  // Track conversations
  messages      Message[]
  lastMessageAt DateTime? // Last message timestamp

  // Published FAQs created from this conversation
  faqItems DataroomFaqItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dataroomId])
  @@index([dataroomDocumentId])
  @@index([linkId])
  @@index([teamId])
  @@index([viewerGroupId])
  @@index([initialViewId])
}

// Define conversation visibility options
enum ConversationVisibility {
  PRIVATE // Only visible to participants and team members
  PUBLIC_LINK // Visible to all viewers with access to the specific link
  PUBLIC_GROUP // Visible to all viewers in the specific group
  PUBLIC_DOCUMENT // Visible to all viewers with access to the document, across any link
  PUBLIC_DATAROOM // Visible to all viewers with access to the dataroom
}

// Define participant roles
enum ParticipantRole {
  OWNER // Created the conversation
  PARTICIPANT // Joined the conversation later
}

// Track participants in a conversation (including the owner)
model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Role in the conversation
  role ParticipantRole @default(PARTICIPANT)

  // Participant can be either a viewer or a user
  viewerId String?
  viewer   Viewer? @relation(fields: [viewerId], references: [id], onDelete: SetNull)
  userId   String?
  user     User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Notification preferences
  receiveNotifications Boolean @default(false)

  createdAt DateTime @default(now())

  @@unique([conversationId, viewerId])
  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([viewerId])
  @@index([userId])
}

model Message {
  id      String @id @default(cuid())
  content String // The actual message content

  // Conversation relationship
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Sender information
  userId String? // Optional - for team members
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  viewerId String? // Optional - for viewers
  viewer   Viewer? @relation(fields: [viewerId], references: [id], onDelete: SetNull)

  // The specific view when this message was sent (for tracking)
  viewId String?
  view   View?   @relation(fields: [viewId], references: [id], onDelete: SetNull)

  // Tracking
  isRead Boolean @default(false)

  // FAQ relationships (reverse relations)
  faqAsQuestion DataroomFaqItem[] @relation("FAQQuestionMessage")
  faqAsAnswer   DataroomFaqItem[] @relation("FAQAnswerMessage")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([conversationId])
  @@index([userId])
  @@index([viewerId])
  @@index([viewId])
}

// Join table to track all views that accessed a conversation
model ConversationView {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  viewId         String
  view           View         @relation(fields: [viewId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([conversationId, viewId])
  @@index([conversationId])
  @@index([viewId])
}

// Published FAQ items for datarooms
model DataroomFaqItem {
  id               String  @id @default(cuid())
  title            String? // Optional title for the FAQ
  editedQuestion   String // Admin-edited version of the question
  originalQuestion String? // Original question from visitor (for reference)
  answer           String // The answer content
  description      String? // Optional context or description

  // Relationships
  dataroomId String
  dataroom   Dataroom @relation(fields: [dataroomId], references: [id], onDelete: Cascade)

  linkId String? // Optional: specific link visibility
  link   Link?   @relation(fields: [linkId], references: [id], onDelete: SetNull)

  dataroomDocumentId String? // Optional: document-specific FAQ
  dataroomDocument   DataroomDocument? @relation(fields: [dataroomDocumentId], references: [id], onDelete: SetNull)

  // Source conversation and messages (for reference and editing)
  sourceConversationId String? // Original conversation
  sourceConversation   Conversation? @relation(fields: [sourceConversationId], references: [id], onDelete: SetNull)

  questionMessageId String? // Reference to original question message
  questionMessage   Message? @relation(name: "FAQQuestionMessage", fields: [questionMessageId], references: [id], onDelete: SetNull)

  answerMessageId String? // Reference to answer message
  answerMessage   Message? @relation(name: "FAQAnswerMessage", fields: [answerMessageId], references: [id], onDelete: SetNull)

  // Publishing details
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  publishedByUserId String
  publishedByUser   User   @relation(fields: [publishedByUserId], references: [id], onDelete: Cascade)

  // Visibility and status
  visibilityMode FaqVisibility @default(PUBLIC_DATAROOM)
  status         FaqStatus     @default(PUBLISHED)
  isAnonymized   Boolean       @default(true)

  // Analytics
  viewCount Int @default(0)

  // Optional categorization
  tags String[] @default([])

  // Metadata
  documentPageNumber    Int? // Optional: specific page reference
  documentVersionNumber Int? // Optional: specific version reference

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dataroomId])
  @@index([linkId])
  @@index([dataroomDocumentId])
  @@index([sourceConversationId])
  @@index([teamId])
  @@index([publishedByUserId])
  @@index([status])
  @@index([visibilityMode])
  @@index([createdAt])
}

// Define FAQ visibility options
enum FaqVisibility {
  PUBLIC_DATAROOM // Visible to all dataroom visitors
  PUBLIC_LINK // Visible only to specific link visitors
  PUBLIC_DOCUMENT // Visible only when viewing specific document
}

// Define FAQ status
enum FaqStatus {
  DRAFT // Not yet published
  PUBLISHED // Live and visible to visitors
  ARCHIVED // No longer visible but kept for reference
}

// --- From entity.prisma ---
model Entity {
  id     String @id @default(cuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  name        String
  description String?

  mode EntityMode @default(FUND)

  fundConfig    Json?
  startupConfig Json?

  feeConfig Json?

  tierConfig Json?

  customSettings Json?

  investors EntityInvestor[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([mode])
}

model EntityInvestor {
  id         String   @id @default(cuid())
  entityId   String
  entity     Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)
  investorId String
  investor   Investor @relation(fields: [investorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([entityId, investorId])
  @@index([entityId])
  @@index([investorId])
}

// --- From integration.prisma ---
model Integration {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  readme      String?
  developer   String
  website     String
  logo        String?
  screenshots Json?
  verified    Boolean  @default(false)
  installUrl  String?
  category    String?
  comingSoon  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  installedIntegrations InstalledIntegration[]
}

model InstalledIntegration {
  id            String  @id @default(cuid())
  credentials   Json?
  configuration Json?
  enabled       Boolean @default(true)

  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  userId        String? // user who installed the integration
  user          User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  teamId        String // team where the integration was installed
  team          Team        @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, integrationId])
  // @@index([teamId]) — REMOVED: redundant, covered by @@unique([teamId, integrationId])
  @@index([integrationId])
}

// --- From qanda.prisma ---
// Viewer Notes - Freeform feedback on documents
model ViewerNote {
  id      String @id @default(cuid())
  content String @db.Text

  // Link to viewer context
  viewId String
  view   View   @relation(fields: [viewId], references: [id], onDelete: Cascade)

  // Optional document context
  documentId String?
  document   Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Dataroom context (if applicable)
  dataroomId String?
  dataroom   Dataroom? @relation(fields: [dataroomId], references: [id], onDelete: Cascade)

  // Link context
  linkId String
  link   Link   @relation(fields: [linkId], references: [id], onDelete: Cascade)

  // Team for admin access
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Viewer info
  viewerEmail String?
  viewerName  String?

  // Page context (optional - which page the note was made on)
  pageNumber Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([viewId])
  @@index([documentId])
  @@index([dataroomId])
  @@index([linkId])
  // @@index([teamId]) — REMOVED: redundant, covered by @@index([teamId, createdAt(sort: Desc)])
  @@index([teamId, createdAt(sort: Desc)])
}

// Dataroom Questions - Private questions from viewers to admins
model DataroomQuestion {
  id      String         @id @default(cuid())
  subject String?
  content String         @db.Text
  status  QuestionStatus @default(OPEN)

  // Link to viewer context
  viewId String?
  view   View?   @relation(fields: [viewId], references: [id], onDelete: SetNull)

  // Viewer reference
  viewerId String?
  viewer   Viewer? @relation(fields: [viewerId], references: [id], onDelete: SetNull)

  // Optional document context
  documentId String?
  document   Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  // Dataroom context (if applicable)
  dataroomId String?
  dataroom   Dataroom? @relation(fields: [dataroomId], references: [id], onDelete: Cascade)

  // Link context
  linkId String
  link   Link   @relation(fields: [linkId], references: [id], onDelete: Cascade)

  // Team for admin access
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Viewer info (cached for display even if viewer is deleted)
  viewerEmail String
  viewerName  String?

  // Page context (optional - which page the question was asked on)
  pageNumber Int?

  // Email threading support
  replyToken     String  @unique @default(cuid())
  emailMessageId String? // Original email message ID for threading

  // Messages/replies in this question thread
  messages DataroomQuestionMessage[]

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime?

  @@index([viewId])
  @@index([viewerId])
  @@index([documentId])
  @@index([dataroomId])
  @@index([linkId])
  @@index([teamId, status]) // Composite: covers teamId-only queries via prefix scan + status filtering
  @@index([teamId, createdAt(sort: Desc)]) // Composite: covers teamId-only queries via prefix scan + time-ordered listing
  @@index([replyToken])
}

// Messages within a question thread (replies from admin or viewer)
model DataroomQuestionMessage {
  id         String           @id @default(cuid())
  questionId String
  question   DataroomQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  content     String            @db.Text
  senderType  MessageSenderType
  senderEmail String
  senderName  String?

  // Email metadata for threading
  emailMessageId String? // Email message ID if this came from email
  inReplyTo      String? // Message ID this is replying to

  // IP and user agent for audit
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  // @@index([questionId]) — REMOVED: redundant, covered by @@index([questionId, createdAt])
  @@index([questionId, createdAt])
}

enum QuestionStatus {
  OPEN
  ANSWERED
  CLOSED
}

enum MessageSenderType {
  VIEWER
  ADMIN
}

// --- From workflow.prisma ---
// Workflow models for routing visitors based on email/domain rules

enum WorkflowStepType {
  ROUTER // Route to different links based on conditions
}

enum ExecutionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  BLOCKED
}

model Workflow {
  id          String   @id @default(cuid())
  name        String
  description String?
  entryLinkId String   @unique
  teamId      String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  entryLink  Link                @relation(fields: [entryLinkId], references: [id], onDelete: Cascade)
  team       Team                @relation(fields: [teamId], references: [id], onDelete: Cascade)
  steps      WorkflowStep[]
  executions WorkflowExecution[]

  @@index([entryLinkId])
  @@index([teamId])
  @@index([isActive])
}

model WorkflowStep {
  id         String           @id @default(cuid())
  workflowId String
  name       String
  stepOrder  Int // Execution order (priority-based routing)
  stepType   WorkflowStepType @default(ROUTER)
  conditions Json // JSON array of conditions to evaluate
  actions    Json // JSON array of actions to execute
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  workflow      Workflow          @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  executionLogs WorkflowStepLog[]

  @@unique([workflowId, stepOrder])
  @@index([workflowId])
}

model WorkflowExecution {
  id           String          @id @default(cuid())
  workflowId   String
  visitorEmail String?
  visitorIp    String?
  status       ExecutionStatus
  startedAt    DateTime        @default(now())
  completedAt  DateTime?
  result       Json? // Final result/output (routing target)
  metadata     Json? // Context data (referrer, user agent, etc.)

  workflow Workflow          @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  stepLogs WorkflowStepLog[]

  @@index([workflowId, startedAt])
  @@index([visitorEmail])
  @@index([status])
}

model WorkflowStepLog {
  id                String   @id @default(cuid())
  executionId       String
  workflowStepId    String
  conditionsMatched Boolean
  conditionResults  Json? // Which conditions passed/failed
  actionsExecuted   Json? // Which actions ran
  executedAt        DateTime @default(now())
  duration          Int? // Execution time in ms
  error             String?

  execution WorkflowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  step      WorkflowStep      @relation(fields: [workflowStepId], references: [id], onDelete: Cascade)

  @@index([executionId])
  @@index([workflowStepId])
}

// --- Push Notifications ---
// Web Push notification subscriptions and preferences

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @unique
  p256dh    String // Public key for encryption
  auth      String // Auth secret for encryption
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model NotificationPreference {
  id     String @id @default(cuid())
  userId String @unique

  // Email notification preferences
  emailDocumentViewed    Boolean              @default(true)
  emailSignatureComplete Boolean              @default(true)
  emailCapitalCall       Boolean              @default(true)
  emailDistribution      Boolean              @default(true)
  emailNewDocument       Boolean              @default(true)
  emailWeeklyDigest      Boolean              @default(false)
  emailDigestFrequency   EmailDigestFrequency @default(WEEKLY) // Controls batch frequency for email notifications

  // Push notification preferences
  pushDocumentViewed    Boolean @default(false)
  pushSignatureComplete Boolean @default(true)
  pushCapitalCall       Boolean @default(true)
  pushDistribution      Boolean @default(true)
  pushNewDocument       Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  data      Json? // Additional context (documentId, linkId, etc.)
  read      Boolean          @default(false)
  sent      Boolean          @default(false) // Whether push was sent
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([userId, createdAt])
}

enum NotificationType {
  DOCUMENT_VIEWED
  SIGNATURE_COMPLETE
  SIGNATURE_REQUESTED
  CAPITAL_CALL
  DISTRIBUTION
  NEW_DOCUMENT
  ACCREDITATION_UPDATE
  SYSTEM
}

// --- Advanced Reporting ---
// Custom report builder and saved reports

model ReportTemplate {
  id          String     @id @default(cuid())
  teamId      String
  name        String
  description String?
  reportType  ReportType
  config      Json // Report configuration (columns, filters, grouping, etc.)
  schedule    Json? // Optional schedule config for automated reports
  isDefault   Boolean    @default(false)
  // NAMING INCONSISTENCY: `createdById` has the correct naming convention but lacks a User @relation.
  // Phase 2: Add `createdBy User @relation(...)` for referential integrity and type-safe queries.
  createdById String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  team    Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  reports GeneratedReport[]

  @@index([teamId])
  @@index([reportType])
}

model GeneratedReport {
  id          String       @id @default(cuid())
  templateId  String?
  teamId      String
  name        String
  reportType  ReportType
  config      Json // Snapshot of config used to generate
  data        Json? // Cached report data (for quick viewing)
  fileUrl     String? // URL to exported file (PDF, CSV, Excel)
  fileType    String? // pdf, csv, xlsx
  status      ReportStatus @default(PENDING)
  error       String?
  // NAMING INCONSISTENCY: `createdById` has the correct naming convention but lacks a User @relation.
  // Phase 2: Add `createdBy User @relation(...)` for referential integrity and type-safe queries.
  createdById String?
  generatedAt DateTime?
  expiresAt   DateTime? // When cached data/file expires
  createdAt   DateTime     @default(now())

  template ReportTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  team     Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([templateId])
  @@index([status])
}

enum ReportType {
  INVESTOR_SUMMARY // Investor overview and commitments
  CAPITAL_ACTIVITY // Capital calls and distributions
  DOCUMENT_ANALYTICS // Document views and engagement
  VISITOR_ANALYTICS // Visitor tracking across links
  SIGNATURE_STATUS // E-signature completion status
  FUND_PERFORMANCE // Fund performance metrics
  COMPLIANCE_AUDIT // Accreditation and compliance status
  CUSTOM // User-defined custom report
}

enum ReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
  EXPIRED
}

// =============================================
// ENTERPRISE PROVISIONING - Organization Models
// =============================================

model Organization {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique // URL-friendly identifier
  description String?

  // Entity / Legal Info (V11 Section 5 Step 1)
  entityType     String? // LLC, Corporation, LP, GP Entity, Trust, Other
  ein            String? // EIN (AES-256 encrypted via encryptTaxId)
  phone          String? // Primary contact phone
  addressLine1   String? // Street address line 1
  addressLine2   String? // Street address line 2
  addressCity    String? // City
  addressState   String? // State/Province
  addressZip     String? // ZIP/Postal code
  addressCountry String  @default("US") // ISO 3166 country code

  // Branding — DELIBERATE DUPLICATION with Brand model (see Brand model comment above).
  // Organization stores org-wide branding defaults set during GP Onboarding Wizard.
  // Brand model stores team-specific overrides used by useTenantBranding hook and dataroom views.
  // favicon is Organization-only (not on Brand). banner and welcomeMessage are Brand-only (not here).
  logo        String? // Cloud storage URL (S3/Vercel Blob). Also on Brand for team-level override
  brandColor  String? // Hex color. Also on Brand for team-level override
  accentColor String? // Hex color. Also on Brand for team-level override
  favicon     String? // Organization-only — not duplicated on Brand model

  // Company Profile (V11 Section 5 Step 2, Marketplace V2)
  companyDescription String? // Short org description (280 chars max)
  sector             String? // Venture Capital, Real Estate, Private Equity, Startup, Other
  geography          String? // US, North America, Global, Europe, Asia, Other
  website            String? // Company website URL
  foundedYear        Int? // Year org was founded

  // SSO Configuration
  ssoEnabled  Boolean      @default(false)
  ssoProvider SSOProvider?
  ssoConfig   Json? // Provider-specific config (encrypted fields stored separately)

  // Feature Flags (org-level overrides)
  featureFlags Json? // { "dataroom.enabled": true, ... }

  // Product Mode (drives downstream UX: GP dashboard, LP flow, documents)
  productMode EntityMode? // GP_FUND | STARTUP | DATAROOM_ONLY — set during Org Setup Wizard Step 3

  // Legal / Compliance (GP Wizard Step 1)
  legalName        String? // Official legal name as registered with state
  yearIncorporated Int? // Year of incorporation (distinct from foundedYear)
  jurisdiction     String? // US state of incorporation/formation
  previousNames    String? // Previous business names (comma-separated, Form D requires past 5 years)
  contactName      String? // Primary contact full name
  contactEmail     String? // Primary contact email
  contactPhone     String? // Primary contact phone (required for Form D)

  // Bad Actor Certification (Rule 506(d))
  badActorCertified   Boolean   @default(false) // GP has certified no covered persons are disqualified
  badActorCertifiedAt DateTime? // Timestamp of certification
  badActorCertifiedBy String? // userId of certifier

  // SEC / Compliance
  regulationDExemption String? // RULE_506B | RULE_506C | REG_A_PLUS | RULE_504 — org-level default
  formDReminderEnabled Boolean @default(true) // Remind to file Form D after first LP commitment
  relatedPersons       Json? // Form D Section 3: Array of { name, title, address, relationship } for executive officers, directors, promoters

  // Organization-wide settings
  defaults       OrganizationDefaults?
  securityPolicy OrganizationSecurityPolicy?

  // Subscription Tier (CRM billing — Feb 19, 2026)
  subscriptionTier       SubscriptionTier @default(FREE)
  aiCrmEnabled           Boolean   @default(false) // AI CRM add-on active
  aiCrmTrialEndsAt       DateTime? // 14-day AI CRM trial expiry
  stripeCustomerId       String?   @unique // Stripe customer ID (org-level billing)
  stripeSubscriptionId   String? // Stripe subscription ID for base tier
  stripeAiSubscriptionId String? // Stripe subscription ID for AI CRM add-on
  subscriptionStatus     OrgSubscriptionStatus @default(ACTIVE)

  // Relations
  teams                  Team[]
  integrationCredentials OrganizationIntegrationCredential[]
  auditLogs              OrganizationAuditLog[]

  // CRM Relations (Feb 19, 2026)
  emailTemplates    EmailTemplate[]
  outreachSequences OutreachSequence[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}

enum SSOProvider {
  SAML
  OIDC
  AZURE_AD
  OKTA
  GOOGLE_WORKSPACE
}

model OrganizationDefaults {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Feature Flags (baseline defaults for org)
  featureFlags Json? // { "dataroom.enabled": true, "mode": "GP_FUND", ... }

  // Dataroom Defaults
  dataroomConversationsEnabled      Boolean                   @default(false)
  dataroomAgentsEnabled             Boolean                   @default(false)
  dataroomAllowBulkDownload         Boolean                   @default(true)
  dataroomShowLastUpdated           Boolean                   @default(true)
  dataroomChangeNotifications       Boolean                   @default(false)
  dataroomDefaultPermissionStrategy DefaultPermissionStrategy @default(INHERIT_FROM_PARENT)

  // Link Defaults
  linkEmailProtected      Boolean @default(true)
  linkEmailAuthenticated  Boolean @default(false)
  linkAllowDownload       Boolean @default(true)
  linkEnableNotifications Boolean @default(true)
  linkEnableWatermark     Boolean @default(false)
  linkExpirationDays      Int? // Default expiration in days (null = no expiration)
  linkPasswordRequired    Boolean @default(false)

  // Fundroom Defaults
  fundroomNdaGateEnabled           Boolean @default(true)
  fundroomKycRequired              Boolean @default(true)
  fundroomAccreditationRequired    Boolean @default(true)
  fundroomStagedCommitmentsEnabled Boolean @default(false)
  fundroomCallFrequency            String  @default("AS_NEEDED")

  // LP Onboarding Settings
  onboardingStepConfig   Json? // Array of { id, enabled, order } for LP onboarding step toggles
  documentTemplateConfig Json? // Array of { id, status, fileName } for document template states
  allowExternalDocUpload Boolean @default(true) // Allow LPs to upload externally signed documents
  allowGpDocUploadForLp  Boolean @default(true) // Allow GP to upload documents on behalf of LP
  accreditationMethod    String  @default("SELF_ACK") // SELF_ACK | SELF_ACK_MIN_INVEST | ENHANCED
  minimumInvestThreshold Float? // Minimum investment threshold for accreditation verification
  regulationDExemption   String @default("506B")
  requireGpApproval      Boolean @default(true) // Require GP approval before commitment is finalized

  // Notification Preferences (LP Onboarding)
  notifyGpLpOnboardingStart  Boolean @default(true) // Email GP when new LP starts onboarding
  notifyGpCommitment         Boolean @default(true) // Email GP on new commitment submitted
  notifyGpWireUpload         Boolean @default(true) // Email GP on wire confirmation uploaded
  notifyGpLpInactive         Boolean @default(true) // Email GP when LP has been inactive 7+ days
  notifyGpExternalDocUpload  Boolean @default(true) // Email GP when externally signed doc is uploaded by LP
  notifyLpStepComplete       Boolean @default(true) // Email LP on each onboarding step completion
  notifyLpWireConfirm        Boolean @default(true) // Email LP when GP confirms wire receipt
  notifyLpNewDocument        Boolean @default(true) // Email LP when new document is added to vault
  notifyLpChangeRequest      Boolean @default(true) // Email LP when GP requests changes to submission
  notifyLpOnboardingReminder Boolean @default(true) // Email LP reminder if onboarding incomplete after 3 days

  // Share Link Defaults
  shareLinkDefaultExpiry Int? // Days until expiration
  shareLinkRequireEmail  Boolean @default(true)

  // Compliance Defaults
  auditLogRetentionDays Int     @default(2555) // 7 years for SEC/FINRA
  requireMfa            Boolean @default(false)

  // Phase 2: Cap Table (Startup Mode)
  capTableEnabled Boolean @default(false) // Show "Cap Table" nav item in Startup mode sidebar

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrganizationSecurityPolicy {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Authentication
  requireMfa            Boolean  @default(false)
  allowedAuthProviders  String[] // ["google", "email", "sso"]
  sessionTimeoutMinutes Int      @default(43200) // 30 days default
  maxConcurrentSessions Int? // null = unlimited

  // Password Policy (for future use)
  passwordMinLength      Int     @default(8)
  passwordRequireSpecial Boolean @default(false)
  passwordRequireNumbers Boolean @default(true)
  passwordExpiryDays     Int? // null = no expiry

  // IP Restrictions
  ipAllowlist String[] // CIDR ranges
  ipDenylist  String[]

  // Data Protection
  requireEncryption     Boolean @default(true)
  allowExternalSharing  Boolean @default(true)
  allowBulkExport       Boolean @default(true)
  watermarkAllDocuments Boolean @default(false)

  // Lockable Policy Keys (prevents fund/object-level overrides)
  lockedPolicies String[] // e.g., ["requireMfa", "requireEncryption"]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrganizationIntegrationCredential {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Integration identification
  provider    String // e.g., "stripe", "plaid", "persona", "resend"
  environment String @default("production") // "sandbox", "production"

  // Encrypted credentials (stored as encrypted JSON)
  encryptedCredentials String @db.Text
  credentialHash       String // Hash for integrity verification

  // Metadata
  label         String? // User-friendly label
  isActive      Boolean   @default(true)
  lastUsedAt    DateTime?
  lastRotatedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, provider, environment])
  // @@index([organizationId]) — REMOVED: redundant, covered by @@unique([organizationId, provider, environment])
  @@index([provider])
}

model OrganizationAuditLog {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)

  // Actor
  userId    String?
  userEmail String?
  ipAddress String?
  userAgent String?

  // Action
  eventType    OrgAuditEventType
  resourceType String? // e.g., "team", "fund", "dataroom", "integration"
  resourceId   String?
  resourceName String?

  // Change details
  previousValue Json?
  newValue      Json?
  metadata      Json?

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([eventType])
  @@index([userId])
  @@index([createdAt])
}

enum OrgAuditEventType {
  // Organization
  ORG_CREATED
  ORG_UPDATED
  ORG_DELETED
  ORG_BRANDING_UPDATED
  ORG_SSO_CONFIGURED
  ORG_SSO_DISABLED

  // Defaults
  DEFAULTS_UPDATED
  DEFAULTS_PROMOTED
  SECURITY_POLICY_UPDATED

  // Teams
  TEAM_CREATED
  TEAM_UPDATED
  TEAM_DELETED
  TEAM_DEFAULTS_OVERRIDDEN

  // Integrations
  INTEGRATION_ADDED
  INTEGRATION_UPDATED
  INTEGRATION_REMOVED
  INTEGRATION_CREDENTIALS_ROTATED

  // Bulk Operations
  BULK_PROMOTE_STARTED
  BULK_PROMOTE_COMPLETED
  BULK_PROMOTE_FAILED
}

// ============================================================================
// FUNDING MARKETPLACE
// ============================================================================

enum DealStage {
  SOURCED // Initial sourcing — raw opportunity identified
  SCREENING // Preliminary screening by GP
  DUE_DILIGENCE // Active DD in progress
  TERM_SHEET // Term sheet negotiation
  COMMITMENT // LPs committing capital
  CLOSING // Final legal/closing docs
  FUNDED // Capital deployed
  MONITORING // Active portfolio monitoring
  EXIT // Exit event (IPO, M&A, secondary)
  PASSED // GP passed on the deal
  WITHDRAWN // Deal withdrawn by sponsor
}

enum DealType {
  EQUITY // Direct equity investment
  DEBT // Debt/note investment
  CONVERTIBLE // Convertible note or SAFE
  FUND_OF_FUNDS // Investment into another fund
  SECONDARY // Secondary market transaction
  CO_INVESTMENT // Co-invest alongside lead GP
  SPV // Special purpose vehicle
}

enum DealVisibility {
  PRIVATE // Only visible to team members
  INVITE_ONLY // Visible to explicitly invited LPs
  QUALIFIED // Visible to accredited/qualified investors
  PUBLIC // Listed on marketplace (still gated by auth)
}

enum InterestStatus {
  EXPRESSED // LP expressed initial interest
  REVIEWING // LP reviewing materials
  COMMITTED // LP verbally committed
  ALLOCATED // GP allocated to this LP
  CONFIRMED // LP signed/confirmed allocation
  DECLINED // LP declined
  WAITLISTED // LP on waitlist (oversubscribed)
}

model Deal {
  id     String @id @default(cuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Core deal information
  title       String
  slug        String // URL-friendly identifier
  description String?        @db.Text
  thesis      String?        @db.Text // Investment thesis summary
  dealType    DealType       @default(EQUITY)
  stage       DealStage      @default(SOURCED)
  visibility  DealVisibility @default(PRIVATE)

  // Target company / asset information
  targetName      String? // Company or asset name
  targetSector    String? // Industry sector
  targetSubSector String? // Sub-sector
  targetGeography String? // Geographic focus
  targetWebsite   String?

  // Financial terms
  targetRaise       Decimal? @db.Decimal(18, 2) // Total raise target
  minimumTicket     Decimal? @db.Decimal(18, 2) // Minimum LP commitment
  maximumTicket     Decimal? @db.Decimal(18, 2) // Maximum LP commitment
  preMoneyValuation Decimal? @db.Decimal(18, 2)
  expectedReturn    String? // e.g., "2-3x MOIC" or "15-20% IRR"
  holdPeriod        String? // e.g., "3-5 years"
  managementFee     Decimal? @db.Decimal(5, 4) // e.g., 0.0200 = 2%
  carriedInterest   Decimal? @db.Decimal(5, 4) // e.g., 0.2000 = 20%
  preferredReturn   Decimal? @db.Decimal(5, 4) // e.g., 0.0800 = 8%

  // Aggregate tracking
  totalCommitted Decimal @default(0) @db.Decimal(18, 2)
  totalAllocated Decimal @default(0) @db.Decimal(18, 2)
  investorCount  Int     @default(0)

  // Dates
  sourcedAt   DateTime  @default(now())
  ddStartedAt DateTime?
  termSheetAt DateTime?
  closingDate DateTime? // Expected or actual close
  fundedAt    DateTime?
  exitAt      DateTime?
  deadlineAt  DateTime? // Expression of interest deadline

  // Linked fund (optional — deal may be pre-fund or map to existing fund)
  fundId String?
  fund   Fund?   @relation(fields: [fundId], references: [id], onDelete: SetNull)

  // Lead sponsor / co-invest
  leadSponsor String? // External lead GP or sponsor name
  isLeadDeal  Boolean @default(true) // Whether this team is lead GP
  syndication Json? // Co-invest structure: { coInvestors: [...], carryAllocation: {...} }

  // Metadata
  tags         String[] // Flexible tagging
  customFields Json? // Extensible custom fields
  riskScore    Int? // 1-10 risk rating
  confidential Boolean  @default(true)

  // Creator
  createdByUserId String?
  createdByUser   User?   @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  // Relations
  stageHistory DealStageHistory[]
  interests    DealInterest[]
  allocations  DealAllocation[]
  documents    DealDocument[]
  activities   DealActivity[]
  listings     MarketplaceListing[]
  notes        DealNote[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  @@unique([teamId, slug])
  // @@index([teamId]) — REMOVED: redundant, covered by @@unique([teamId, slug])
  @@index([stage])
  @@index([dealType])
  @@index([visibility])
  @@index([fundId])
  @@index([createdByUserId])
  @@index([deletedAt])
  @@index([deadlineAt])
  @@index([targetSector])
}

model DealStageHistory {
  id     String @id @default(cuid())
  dealId String
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  fromStage DealStage?
  toStage   DealStage
  reason    String?    @db.Text
  metadata  Json?

  changedByUserId String?
  changedByUser   User?   @relation(fields: [changedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([dealId])
  @@index([toStage])
  @@index([createdAt])
}

model DealInterest {
  id     String @id @default(cuid())
  dealId String
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  // Who expressed interest
  investorId String?
  investor   Investor? @relation(fields: [investorId], references: [id], onDelete: SetNull)
  userId     String? // For non-investor users browsing marketplace
  user       User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  status            InterestStatus @default(EXPRESSED)
  indicativeAmount  Decimal?       @db.Decimal(18, 2) // How much LP wants to commit
  notes             String?        @db.Text
  conditionsOrTerms String?        @db.Text // Any conditions on commitment

  // GP response
  gpNotes           String?   @db.Text
  respondedByUserId String?
  respondedAt       DateTime?

  // Conversion tracking
  convertedToInvestmentId String?
  convertedAt             DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([dealId, investorId])
  // @@index([dealId]) — REMOVED: redundant, covered by @@unique([dealId, investorId])
  @@index([investorId])
  @@index([userId])
  @@index([status])
}

model DealAllocation {
  id     String @id @default(cuid())
  dealId String
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  investorId String
  investor   Investor @relation(fields: [investorId], references: [id], onDelete: Cascade)

  requestedAmount Decimal  @db.Decimal(18, 2) // What LP requested
  allocatedAmount Decimal  @db.Decimal(18, 2) // What GP allocated
  confirmedAmount Decimal? @db.Decimal(18, 2) // What LP confirmed

  status      DealAllocationStatus @default(PENDING)
  offeredAt   DateTime?
  respondedAt DateTime?

  // Allocation rationale
  allocationNotes String? @db.Text

  allocatedByUserId String?
  allocatedByUser   User?   @relation(fields: [allocatedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([dealId, investorId])
  // @@index([dealId]) — REMOVED: redundant, covered by @@unique([dealId, investorId])
  @@index([investorId])
  @@index([status])
}

model DealDocument {
  id     String @id @default(cuid())
  dealId String
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  name        String
  description String?
  category    String  @default("GENERAL") // TEASER, NDA, DECK, FINANCIALS, DD_REPORT, TERM_SHEET, LEGAL, GENERAL
  storageKey  String?
  storageType String? // S3_PATH, REPLIT, R2, etc.
  fileType    String? // mime type
  fileSize    Int?

  // Access control
  requiredStage DealStage? // Minimum deal stage to access this doc
  restricted    Boolean    @default(false) // Only allocated investors can view

  uploadedByUserId String?
  uploadedByUser   User?   @relation(fields: [uploadedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealId])
  @@index([category])
}

model DealActivity {
  id     String @id @default(cuid())
  dealId String
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  activityType String // STAGE_CHANGE, NOTE_ADDED, DOCUMENT_UPLOADED, INTEREST_EXPRESSED, ALLOCATION_MADE, MEETING, CALL, EMAIL
  title        String
  description  String? @db.Text
  metadata     Json?

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([dealId])
  @@index([activityType])
  @@index([createdAt])
}

model DealNote {
  id     String @id @default(cuid())
  dealId String
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  content   String  @db.Text
  isPrivate Boolean @default(true) // Only visible to GP team
  pinned    Boolean @default(false)

  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealId])
  @@index([authorId])
}

model MarketplaceListing {
  id     String @id @default(cuid())
  dealId String
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Listing details (may differ from deal for public consumption)
  headline      String
  summary       String   @db.Text
  highlights    String[] // Key selling points
  category      String? // Marketplace browsing category
  coverImageUrl String?

  // Listing control
  isActive    Boolean   @default(false)
  publishedAt DateTime?
  expiresAt   DateTime?
  featured    Boolean   @default(false) // Featured/promoted listing
  sortOrder   Int       @default(0)

  // Engagement metrics
  viewCount     Int @default(0)
  interestCount Int @default(0)
  saveCount     Int @default(0)

  // SEO / discovery
  searchTags String[]

  // Relations
  events MarketplaceEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([dealId])
  @@index([teamId])
  @@index([isActive])
  @@index([category])
  @@index([featured])
  @@index([publishedAt])
}

model OnboardingFlow {
  id         String   @id @default(cuid())
  investorId String
  investor   Investor @relation(fields: [investorId], references: [id], onDelete: Restrict)

  fundId String
  fund   Fund   @relation(fields: [fundId], references: [id], onDelete: Restrict)

  currentStep Int                  @default(0)
  totalSteps  Int                  @default(6)
  status      OnboardingFlowStatus @default(IN_PROGRESS)

  stepsCompleted Json? // { "personal_info": true, "entity_type": true, "address": true, "accreditation": false, ... }
  formData       Json? // Auto-saved form data for resume capability

  startedAt    DateTime  @default(now())
  completedAt  DateTime?
  lastActiveAt DateTime  @default(now())
  abandonedAt  DateTime?

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([investorId, fundId])
  // @@index([investorId]) — REMOVED: redundant, covered by @@unique([investorId, fundId]) and @@index([investorId, status])
  // @@index([fundId]) — REMOVED: redundant, covered by @@index([fundId, status])
  @@index([status])
  @@index([investorId, status])
  @@index([fundId, status])
}

enum OnboardingFlowStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

model ProfileChangeRequest {
  id         String   @id @default(cuid())
  investorId String
  investor   Investor @relation(fields: [investorId], references: [id], onDelete: Restrict)

  fundId String?
  fund   Fund?   @relation(fields: [fundId], references: [id], onDelete: SetNull)

  // NAMING INCONSISTENCY: `requestedBy` and `reviewedBy` are plain Strings storing userId without FK constraints.
  // Phase 2: Rename to `requestedByUserId`/`reviewedByUserId`, add User @relation for referential integrity.
  requestedBy String // User ID of the GP who requested changes
  reviewedBy  String? // User ID of the LP who responded

  status ProfileChangeRequestStatus @default(PENDING)

  changeType     ChangeRequestType // ENTITY_INFO, ACCREDITATION, DOCUMENT, ADDRESS, TAX_ID, BANK_INFO
  fieldName      String? // Specific field that needs changing
  reason         String? // GP's reason for requesting the change
  currentValue   String? // Current value (for reference)
  requestedValue String? // What GP wants it changed to (optional, LP may choose)
  newValue       String? // What LP actually changed it to

  lpNote String? // LP's response note
  gpNote String? // GP's internal note

  requestedAt DateTime  @default(now())
  respondedAt DateTime?
  expiresAt   DateTime? // Auto-expire if LP doesn't respond

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([investorId])
  @@index([fundId])
  @@index([status])
  @@index([requestedBy])
}

enum ProfileChangeRequestStatus {
  PENDING
  APPROVED
  REJECTED
  ACCEPTED
  EXPIRED
}

model FundroomActivation {
  id     String @id @default(cuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Restrict)

  fundId String?
  fund   Fund?   @relation(fields: [fundId], references: [id], onDelete: SetNull)

  status ActivationStatus @default(PENDING)

  activatedBy String? // User ID who activated
  activatedAt DateTime?

  mode String @default("GP_FUND") // GP_FUND, STARTUP

  ndaGateEnabled           Boolean @default(true)
  kycRequired              Boolean @default(true)
  accreditationRequired    Boolean @default(true)
  stagedCommitmentsEnabled Boolean @default(false)

  wireInstructionsConfigured Boolean @default(false)
  documentsConfigured        Boolean @default(false)
  brandingConfigured         Boolean @default(false)

  setupProgress    Json? // { "wire": true, "docs": false, "branding": false, "fund": true }
  setupCompletedAt DateTime?

  deactivatedAt      DateTime?
  deactivatedBy      String?
  deactivationReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, fundId])
  // @@index([teamId]) — REMOVED: redundant, covered by @@unique([teamId, fundId])
  @@index([fundId])
  @@index([status])
}

// --- Platform Settings (singleton) ---
// Platform-wide configuration controlled by platform owner.
// Only one record should exist (key: "default"). Use upsert pattern.
model PlatformSettings {
  id  String @id @default(cuid())
  key String @unique @default("default") // Singleton key

  // Paywall enforcement
  paywallEnforced    Boolean   @default(true) // When false, all orgs get full access (like PAYWALL_BYPASS but DB-driven)
  paywallBypassUntil DateTime? // Time-limited bypass (e.g., launch period)

  // Platform toggles
  registrationOpen   Boolean @default(true) // Can new orgs sign up?
  maintenanceMode    Boolean @default(false) // Platform-wide maintenance
  maintenanceMessage String? // Custom maintenance message

  // Updated by
  updatedBy String? // userId of platform owner who last modified
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

// --- Marketplace V2 Framework Models ---

model MarketplaceWaitlist {
  id    String @id @default(cuid())
  email String @unique

  name                  String?
  investorType          String? // INDIVIDUAL, INSTITUTIONAL, FAMILY_OFFICE, RIA, OTHER
  investmentPreferences Json? // { "sectors": [], "geographies": [], "minInvestment": 0, "maxInvestment": 0 }
  source                String? // WEBSITE, REFERRAL, EVENT, SOCIAL, OTHER
  referralCode          String?

  // Engagement tracking
  notifiedAt      DateTime? // Last time we sent them a marketplace update
  convertedAt     DateTime? // When they created an investor account
  convertedUserId String? // Link to User who signed up
  convertedUser   User?     @relation("MarketplaceWaitlistConversions", fields: [convertedUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([source])
  @@index([investorType])
  @@index([createdAt])
}

model MarketplaceEvent {
  id        String              @id @default(cuid())
  listingId String?
  listing   MarketplaceListing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  eventType String // VIEW, CLICK, SAVE, UNSAVE, INTEREST_EXPRESSED, SHARE, SEARCH, FILTER

  actorUserId String? // Logged-in user (null for anonymous)
  actorEmail  String? // Email if captured via gate

  ip        String?
  userAgent String?
  referrer  String? // HTTP referrer

  metadata Json? // { "searchQuery": "", "filterCategory": "", "position": 0, "source": "homepage|search|direct" }

  createdAt DateTime @default(now())

  @@index([listingId])
  @@index([eventType])
  @@index([actorUserId])
  @@index([createdAt])
}

// =============================================================================
// Premium Offering Landing Page
// =============================================================================
// GP-customizable, branded, investor-facing landing page for a specific fund.
// Public-facing (no auth required to view). URL: /offering/[slug]
// Premium feature — "Powered by FundRoom" badge removable for $40/mo.

model OfferingPage {
  id     String @id @default(cuid())
  fundId String
  fund   Fund   @relation(fields: [fundId], references: [id], onDelete: Restrict)
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Restrict)

  slug     String  @unique // URL slug — /offering/[slug]
  isPublic Boolean @default(false) // GP must publish before visible

  // Hero Section
  heroHeadline    String? // Main headline override (default: fund name)
  heroSubheadline String? @db.Text // Subheadline text
  heroImageUrl    String? // Background or hero image URL
  heroBadgeText   String? // e.g., "Now Open", "Closing Soon", "506(c)"

  // Offering Overview
  offeringDescription String? @db.Text // Rich description of the offering

  // Key Metrics (GP-configurable cards)
  keyMetrics Json? // Array of { label, value, subtext? } — e.g., [{ "label": "Target Raise", "value": "$9.55M" }]

  // Investment Highlights (bullet cards)
  highlights Json? // Array of { title, description, icon? }

  // Deal Structure / Terms (key-value pairs)
  dealTerms Json? // Array of { label, value } — e.g., [{ "label": "Management Fee", "value": "2.0%" }]

  // Timeline / Milestones
  timeline Json? // Array of { date, title, description, status: "completed" | "current" | "upcoming" }

  // Leadership Team
  leadership Json? // Array of { name, title, bio?, imageUrl? }

  // Gallery / Media
  gallery Json? // Array of { url, caption?, type: "image" | "video" }

  // Dataroom Documents (gated vs open)
  dataroomDocuments Json? // Array of { name, type, isGated, url? }

  // Financial Projections
  financialProjections Json? // { sections: [{ title, headers, rows }] }

  // Competitive Advantages / Feature Grid
  advantages Json? // Array of { title, description, icon? }

  // CTA Configuration
  ctaText          String? // Override CTA button text (default: "I Want to Invest")
  ctaSecondary     String? // Secondary CTA text (e.g., "Request More Info")
  emailGateEnabled Boolean @default(true) // Require email to access full page

  // Branding Overrides (falls back to org/team branding)
  brandColor  String? // Hex color override
  accentColor String? // Hex accent color override
  logoUrl     String? // Logo override
  customCss   String? @db.Text // Custom CSS snippet (advanced)

  // Compliance Footer
  disclaimerText String? @db.Text // Custom disclaimer (appended to standard SEC disclaimer)

  // Premium Feature: Remove "Powered by FundRoom" badge
  removeBranding Boolean @default(false) // Paid feature: $40/mo

  // SEO / Meta
  metaTitle       String?
  metaDescription String?
  metaImageUrl    String? // OG image

  // Analytics
  viewCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fundId])
  @@index([teamId])
  @@index([slug])
}

// =============================================================================
// CRM Foundation (Feb 19, 2026)
// =============================================================================
// Unified contact management system that consolidates dataroom visitors,
// investor profiles, deal interest expressions, and marketplace waitlist leads
// into a single CRM entity. Supports auto-capture from signing events,
// lifecycle tracking, and e-signature usage metering.

/// CRM-specific role for granular pipeline access control.
/// Applied per team member via Settings > Team Management.
/// Complements (not replaces) the team-level Role enum.
enum CrmRole {
  VIEWER // Can see pipeline, contact details, activity history. Cannot modify contacts or send emails.
  CONTRIBUTOR // Can add contacts, update notes, set follow-up reminders. Cannot send outreach emails.
  MANAGER // Full CRM access: send emails, manage sequences, approve AI drafts, configure outreach settings.
}

enum ContactStatus {
  PROSPECT // Initial capture (dataroom view, waitlist signup)
  LEAD // Qualified prospect (verified email, engaged)
  OPPORTUNITY // Active deal/investment discussion
  CUSTOMER // Committed investor or signed agreement
  WON // Fully funded / closed
  LOST // Declined, rejected, or disengaged
  ARCHIVED // Manually archived by GP
}

enum ContactSource {
  DATAROOM_VIEW // Captured from dataroom visitor tracking
  INVESTOR_ONBOARDING // LP registration / onboarding wizard
  DEAL_INTEREST // Interest expression on a marketplace deal
  MANUAL_ENTRY // GP manually created contact
  MARKETPLACE_WAITLIST // Waitlist signup
  SIGNATURE_EVENT // Auto-captured during e-signature flow
  BULK_IMPORT // CSV/bulk import
  REFERRAL // Referred by another contact
}

model Contact {
  id     String @id @default(cuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Restrict)

  // Identity (email is the primary dedup key per team)
  email     String
  firstName String?
  lastName  String?
  phone     String?
  company   String? // Company or entity name
  title     String? // Job title / role

  // CRM lifecycle
  status ContactStatus @default(PROSPECT)
  source ContactSource @default(MANUAL_ENTRY)

  // Linked records (nullable — contact may exist before investor profile)
  investorId String?   @unique
  investor   Investor? @relation(fields: [investorId], references: [id], onDelete: SetNull)

  // Owner/assignment (GP team member responsible for this contact)
  assignedToId String?
  assignedTo   User?   @relation("ContactAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)

  // Engagement scoring
  engagementScore Int       @default(0) // Computed from activities/views
  lastEngagedAt   DateTime? // Last meaningful interaction timestamp

  // Tags (stored as JSON array of strings for simplicity)
  tags Json? // ["high-net-worth", "referred", "vc-partner"]

  // Custom fields (extensible JSON for GP-defined fields)
  customFields Json? // { "region": "Northeast", "referredBy": "John Smith" }

  // Metadata
  referralSource String? // How they found us (campaign, URL, etc.)
  notes          String? @db.Text // Quick notes (full notes in ContactNote)

  // Outreach tracking (Feb 19, 2026)
  lastContactedAt DateTime? // Last outbound email / call / meeting
  nextFollowUpAt  DateTime? // Scheduled follow-up date for outreach queue
  lastEmailedAt   DateTime? // Last CRM outreach email sent
  unsubscribedAt  DateTime? // If set, do NOT send outreach emails
  emailBounced    Boolean   @default(false) // Hard bounce detected

  // Timestamps
  convertedAt DateTime? // When status moved from PROSPECT/LEAD to OPPORTUNITY+
  closedAt    DateTime? // When status moved to WON or LOST
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  contactNotes      ContactNote[]
  contactActivities ContactActivity[]

  @@unique([teamId, email]) // One contact per email per team
  // @@index([teamId]) — REMOVED: redundant, covered by @@unique([teamId, email]) and @@index([teamId, status])
  @@index([email])
  @@index([status])
  @@index([source])
  @@index([assignedToId])
  @@index([teamId, status])
  @@index([teamId, source])
  @@index([investorId])
  @@index([nextFollowUpAt])
  @@index([lastContactedAt])
}

model ContactNote {
  id        String  @id @default(cuid())
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  authorId String
  author   User   @relation("ContactNoteAuthor", fields: [authorId], references: [id], onDelete: Restrict)

  content String @db.Text

  isPinned  Boolean @default(false)
  isPrivate Boolean @default(false) // Only visible to author if true

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // @@index([contactId]) — REMOVED: redundant, covered by @@index([contactId, isPinned])
  @@index([authorId])
  @@index([contactId, isPinned])
}

enum ContactActivityType {
  STATUS_CHANGE // Contact status transition
  NOTE_ADDED // Note created
  EMAIL_SENT // Outbound email to contact
  EMAIL_OPENED // Email open tracked
  EMAIL_REPLIED // Inbound email reply from contact (outreach tracking)
  LINK_CLICKED // Tracked link clicked in outreach email
  DOCUMENT_VIEWED // Dataroom document viewed
  DOCUMENT_SIGNED // E-signature completed
  DEAL_INTEREST // Interest expressed in a deal
  MEETING // Meeting scheduled/completed
  CALL // Phone call logged
  TASK_COMPLETED // Task completed related to contact
  COMMITMENT_MADE // Investment commitment
  WIRE_RECEIVED // Wire transfer received
  PROFILE_UPDATED // Contact profile updated
  ASSIGNED // Contact assigned to team member
  CREATED // Contact created (auto or manual)
}

model ContactActivity {
  id        String  @id @default(cuid())
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  type ContactActivityType

  // Actor (who performed the activity — null for system-generated)
  actorId String?
  actor   User?   @relation("ContactActivityActor", fields: [actorId], references: [id], onDelete: SetNull)

  // Description (human-readable summary)
  description String

  // Metadata (type-specific details)
  metadata Json? // { "previousStatus": "LEAD", "newStatus": "OPPORTUNITY", "documentId": "...", "amount": 50000 }

  // Optional linked resources
  dealId     String? // Link to Deal if activity is deal-related
  documentId String? // Link to document if activity is doc-related
  fundId     String? // Link to fund if activity is fund-related
  emailId    String? // Resend email ID for open/click tracking

  createdAt DateTime @default(now())

  // @@index([contactId]) — REMOVED: redundant, covered by @@index([contactId, type])
  @@index([type])
  @@index([contactId, type])
  @@index([actorId])
  @@index([createdAt])
}

// =============================================================================
// E-Signature Usage Tracking (Feb 19, 2026)
// =============================================================================
// Per-team usage records for e-signature quota enforcement.
// Each completed signature document increments the team's monthly usage.
// TierResolver checks this against plan limits.

model EsigUsageRecord {
  id     String @id @default(cuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Restrict)

  // Billing period tracking
  periodStart DateTime // Start of the billing period (month)
  periodEnd   DateTime // End of the billing period (month)

  // Usage counters
  documentsCreated  Int @default(0) // Signature documents created this period
  documentsSent     Int @default(0) // Documents sent for signing this period
  documentsComplete Int @default(0) // Documents fully signed this period

  // Linked document (optional — for per-document tracking)
  signatureDocumentId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, periodStart]) // One record per team per period
  // @@index([teamId]) — REMOVED: redundant, covered by @@unique([teamId, periodStart]) and @@index([teamId, periodStart, periodEnd])
  @@index([periodStart])
  @@index([teamId, periodStart, periodEnd])
}

// =============================================================================
// CRM Outreach & Email Templates (Feb 19, 2026)
// =============================================================================
// Email templates, outreach sequences, and enrollment tracking for the
// investor CRM system. Part of the CRM_PRO / FUNDROOM / AI_CRM tier features.

model EmailTemplate {
  id    String       @id @default(cuid())
  orgId String
  org   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  name     String // Template display name
  subject  String // Email subject line (supports merge vars: {{contact.firstName}}, etc.)
  body     String  @db.Text // Email body HTML (supports merge vars)
  isSystem Boolean @default(false) // System templates cannot be deleted
  category String? // INVITATION, FOLLOW_UP, COMMITMENT, WIRE, UPDATE, CUSTOM

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, isSystem])
  @@index([orgId, category])
}

model OutreachSequence {
  id    String       @id @default(cuid())
  orgId String
  org   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  name        String
  description String?
  isActive    Boolean @default(true)

  steps       OutreachStep[]
  enrollments SequenceEnrollment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // @@index([orgId]) — REMOVED: redundant, covered by @@index([orgId, isActive])
  @@index([orgId, isActive])
}

model OutreachStep {
  id         String           @id @default(cuid())
  sequenceId String
  sequence   OutreachSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  stepOrder  Int // 0-indexed order within sequence
  delayDays  Int     @default(3) // Days to wait before executing this step
  templateId String? // Reference to EmailTemplate.id (not FK — template may be deleted)
  aiPrompt   String? @db.Text // AI CRM prompt for generating email content
  condition  OutreachStepCondition @default(ALWAYS)

  @@index([sequenceId, stepOrder])
}

model SequenceEnrollment {
  id         String           @id @default(cuid())
  orgId      String
  contactId  String // Reference to Contact.id
  sequenceId String
  sequence   OutreachSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  currentStep  Int       @default(0) // Current step index in sequence
  status       SequenceEnrollmentStatus @default(ACTIVE)
  nextStepAt   DateTime? // When the next step should execute
  pausedReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([contactId, sequenceId])
  @@index([orgId, status])
  @@index([nextStepAt])
  @@index([status, nextStepAt])
}

// =============================================================================
// E-Signature Usage Metering (simplified monthly counter — Feb 19, 2026)
// =============================================================================
// Simpler month-keyed model for tier limit checks. The existing EsigUsageRecord
// provides detailed per-document tracking; this model is for quick tier enforcement.

model EsigUsage {
  id             String @id @default(cuid())
  orgId          String
  month          String // Format: 'YYYY-MM'
  signaturesUsed Int    @default(0)
  signersStored  Int    @default(0)
  // @@index([orgId]) — REMOVED: redundant, covered by @@unique([orgId, month])

  @@unique([orgId, month])
}

// =============================================================================
// Pending Contacts (Feb 19, 2026)
// =============================================================================
// Contacts captured when org is on FREE tier and at contact limit.
// Auto-converted to Contact records on upgrade to CRM_PRO or FUNDROOM.

model PendingContact {
  id            String   @id @default(cuid())
  orgId         String
  email         String
  firstName     String?
  lastName      String?
  source        ContactSource @default(DATAROOM_VIEW)
  viewerEventId String? // Optional link to the viewer event that created this
  createdAt     DateTime @default(now())
  // @@index([orgId]) — REMOVED: redundant, covered by @@unique([orgId, email])

  @@unique([orgId, email])
}

// =============================================================================
// PHASE 2 MODELS — Cap Table (Startup Mode)
// =============================================================================
// @map: Phase 2 — Cap table tracking for startup raises (SAFE, Priced Round, etc.)
// These models are empty placeholders seeded now to avoid painful migrations later.
// The capTableEnabled flag on OrganizationDefaults controls sidebar visibility.

model CapTableEntry {
  id     String @id @default(cuid())
  fundId String
  fund   Fund   @relation(fields: [fundId], references: [id], onDelete: Restrict)

  // Security holder
  holderId   String // Investor or founder ID
  holderType HolderType
  holderName String

  // Security details
  securityType  SecurityType
  shares        Decimal? @db.Decimal(18, 4) // Number of shares/units
  pricePerShare Decimal? @db.Decimal(18, 6) // Price per share at issuance
  valuationCap  Decimal? @db.Decimal(18, 2) // SAFE/Conv Note cap
  discountPct   Decimal? @db.Decimal(5, 4) // Discount rate as decimal

  // Vesting (if applicable)
  vestingSchedule    VestingScheduleType? // FOUR_YEAR_ONE_CLIFF | THREE_YEAR_MONTHLY | CUSTOM | null (fully vested)
  vestingStartDate   DateTime?
  cliffDate          DateTime?
  totalVestingMonths Int?
  vestedShares       Decimal?  @db.Decimal(18, 4)

  // Status
  status        CapTableEntryStatus @default(ACTIVE)
  issuedAt      DateTime  @default(now())
  cancelledAt   DateTime?
  convertedAt   DateTime?
  convertedToId String? // ID of CapTableEntry this was converted into

  // Document references
  documentId String? // SignatureDocument ID for the instrument agreement

  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  issuances SecurityIssuance[]

  @@index([fundId])
  @@index([holderId])
  @@index([securityType])
  @@index([status])
}

model SecurityIssuance {
  id              String        @id @default(cuid())
  capTableEntryId String
  capTableEntry   CapTableEntry @relation(fields: [capTableEntryId], references: [id], onDelete: Restrict)

  // Issuance details
  eventType     IssuanceEventType
  shares        Decimal  @db.Decimal(18, 4) // Shares involved in this event
  pricePerShare Decimal? @db.Decimal(18, 6) // Price at event time
  totalAmount   Decimal? @db.Decimal(18, 2) // Total consideration

  // Board approval
  boardApprovalDate DateTime?
  boardResolutionId String? // Reference to board resolution document

  // Audit
  authorizedBy String? // User ID who authorized
  notes        String? @db.Text
  metadata     Json?

  createdAt DateTime @default(now())

  @@index([capTableEntryId])
  @@index([eventType])
}

// =============================================================================
// PHASE 2 MODELS — Waterfall / Distribution Engine (GP Fund Mode)
// =============================================================================
// @map: Phase 2 — Waterfall calculation engine for European/American/Deal-by-Deal distributions
// The WaterfallType enum on Fund model controls which algorithm runs.
// Calculations are stored for audit trail and replay capabilities.

model WaterfallCalculation {
  id     String @id @default(cuid())
  fundId String
  fund   Fund   @relation(fields: [fundId], references: [id], onDelete: Restrict)

  // Calculation context
  calculationType WaterfallCalculationType
  waterfallType   WaterfallType // Algorithm used (European, American, Deal-by-Deal)
  calculationDate DateTime // As-of date for the calculation
  periodStart     DateTime? // Period start (for periodic calculations)
  periodEnd       DateTime? // Period end

  // Inputs (snapshot at calculation time)
  totalCommitted     Decimal  @db.Decimal(18, 2) // Total LP commitments
  totalContributed   Decimal  @db.Decimal(18, 2) // Total capital called
  totalDistributed   Decimal  @db.Decimal(18, 2) // Total distributions to date
  totalRealized      Decimal  @db.Decimal(18, 2) // Realized gains
  totalUnrealized    Decimal  @db.Decimal(18, 2) // Unrealized (NAV-based)
  hurdleRate         Decimal  @db.Decimal(5, 4) // Hurdle rate at calculation time
  catchUpPct         Decimal  @db.Decimal(5, 4) // Catch-up percentage
  carryPct           Decimal  @db.Decimal(5, 4) // Carry percentage
  gpCommitmentAmount Decimal? @db.Decimal(18, 2)

  // Outputs
  returnOfCapital Decimal @db.Decimal(18, 2) // Step 1: Return of contributed capital
  preferredReturn Decimal @db.Decimal(18, 2) // Step 2: Preferred return (hurdle)
  gpCatchUp       Decimal @db.Decimal(18, 2) // Step 3: GP catch-up
  carriedInterest Decimal @db.Decimal(18, 2) // Step 4: Carried interest split
  lpDistribution  Decimal @db.Decimal(18, 2) // Total LP distribution
  gpDistribution  Decimal @db.Decimal(18, 2) // Total GP distribution (carry + commitment return)

  // Per-LP breakdown (stored as JSON for flexibility)
  lpBreakdown Json? // Array of { investorId, committed, contributed, distributed, share }

  // Metrics at calculation time
  irr  Decimal? @db.Decimal(8, 4) // Internal Rate of Return
  tvpi Decimal? @db.Decimal(8, 4) // Total Value to Paid-In
  dpi  Decimal? @db.Decimal(8, 4) // Distributions to Paid-In
  rvpi Decimal? @db.Decimal(8, 4) // Residual Value to Paid-In
  moic Decimal? @db.Decimal(8, 4) // Multiple on Invested Capital

  // Audit
  status         WaterfallCalculationStatus @default(DRAFT)
  approvedBy     String?
  approvedAt     DateTime?
  executedAt     DateTime?
  distributionId String? // Link to Distribution record if executed
  notes          String?   @db.Text
  metadata       Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fundId])
  @@index([calculationType])
  @@index([status])
  @@index([calculationDate])
}

// =============================================================================
// ENUMS — String→Enum Migration (Feb 20, 2026)
// =============================================================================
// Converted from plain String fields to typed enums for type safety and data integrity.

enum YearInReviewStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum SubscriptionStatus {
  PENDING
  SIGNED
  PAYMENT_PROCESSING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum UserTeamStatus {
  ACTIVE
  BLOCKED
  BLOCKED_TRIAL_EXPIRED
}

enum SubscriptionTier {
  FREE
  CRM_PRO
  FUNDROOM
}

enum OrgSubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
  CANCEL_AT_PERIOD_END
}

enum DealAllocationStatus {
  PENDING
  OFFERED
  ACCEPTED
  REJECTED
  REDUCED
}

enum ChangeRequestType {
  ENTITY_INFO
  ACCREDITATION
  DOCUMENT
  ADDRESS
  TAX_ID
  BANK_INFO
}

enum OutreachStepCondition {
  ALWAYS
  IF_NO_REPLY
  IF_NOT_OPENED
  IF_NOT_CLICKED
}

enum SequenceEnrollmentStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum HolderType {
  INVESTOR
  FOUNDER
  EMPLOYEE
  ADVISOR
}

enum SecurityType {
  COMMON
  PREFERRED
  SAFE
  CONVERTIBLE_NOTE
  OPTION
  WARRANT
}

enum VestingScheduleType {
  FOUR_YEAR_ONE_CLIFF
  THREE_YEAR_MONTHLY
  CUSTOM
}

enum CapTableEntryStatus {
  ACTIVE
  CONVERTED
  CANCELLED
  EXERCISED
}

enum WaterfallCalculationType {
  DISTRIBUTION
  WHAT_IF
  YEAR_END
  FINAL_LIQUIDATION
}

enum WaterfallCalculationStatus {
  DRAFT
  APPROVED
  EXECUTED
  VOIDED
}

enum IssuanceEventType {
  INITIAL_GRANT
  EXERCISE
  CONVERSION
  TRANSFER
  REPURCHASE
  CANCELLATION
}

// ============================================================================
// E-SIGNATURE PLATFORM ENHANCEMENTS & SHARED DRIVE (Feb 20, 2026)
// Standalone e-signature sending, document filing, contact vaults,
// verification codes, and parallel signing support.
// ============================================================================

enum SigningMode {
  SEQUENTIAL // Recipients sign one at a time, ordered by signingOrder
  PARALLEL // All recipients can sign simultaneously
  MIXED // Groups of recipients sign in parallel, groups proceed sequentially (signingOrder defines group)
}

// Standalone e-signature envelope — wraps a signature request that can be sent
// to ANY email address without requiring a dataroom, fund, or investor context.
// This is the core model for competing with DocuSign/PandaDoc standalone sending.
model Envelope {
  id          String         @id @default(cuid())
  teamId      String
  team        Team           @relation(fields: [teamId], references: [id], onDelete: Restrict)
  createdById String
  createdBy   User           @relation("EnvelopeCreator", fields: [createdById], references: [id], onDelete: Restrict)

  // Envelope metadata
  title       String
  description String?
  status      EnvelopeStatus @default(DRAFT)

  // Source document
  documentId      String? // Optional link to SignatureDocument (created when envelope is prepared)
  signatureDocId  String? @unique // 1:1 link to the underlying SignatureDocument
  sourceFile      String? // Original uploaded file reference (before field placement)
  sourceStorageType DocumentStorageType @default(VERCEL_BLOB)
  sourceFileName    String?
  sourceMimeType    String?
  sourceFileSize    BigInt?
  sourceNumPages    Int?

  // Sending configuration
  signingMode SigningMode @default(SEQUENTIAL)
  emailSubject String?
  emailMessage String?
  expiresAt    DateTime? // Envelope expiration date
  reminderEnabled Boolean @default(true)
  reminderDays    Int     @default(3) // Days between reminders
  maxReminders    Int     @default(3)

  // Completion tracking
  sentAt      DateTime?
  completedAt DateTime?
  voidedAt    DateTime?
  voidedReason String?
  declinedAt  DateTime?
  declinedBy  String? // Email of the decliner

  // Signed output
  signedFileUrl     String? // Flattened signed PDF with audit trail appended
  signedStorageType DocumentStorageType?
  auditTrailPdf     String? // Standalone audit trail PDF (Certificate of Completion)

  // Recipients
  recipients EnvelopeRecipient[]
  filings    DocumentFiling[] // Auto-filing records

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId, status])
  @@index([createdById])
  @@index([status])
}

enum EnvelopeStatus {
  DRAFT // Created but not yet sent
  PREPARING // Fields being placed on document
  SENT // Sent to recipients, awaiting signatures
  VIEWED // At least one recipient has viewed
  PARTIALLY_SIGNED // Some recipients have signed
  COMPLETED // All signers have signed
  DECLINED // A signer declined
  VOIDED // Sender cancelled/voided the envelope
  EXPIRED // Envelope expired before completion
}

// Individual recipient within an Envelope (standalone e-sig context)
model EnvelopeRecipient {
  id         String   @id @default(cuid())
  envelopeId String
  envelope   Envelope @relation(fields: [envelopeId], references: [id], onDelete: Cascade)

  // Recipient info — can be ANY email, no account required
  name  String
  email String
  role  EnvelopeRecipientRole @default(SIGNER)
  order Int @default(1) // Signing order (for sequential/mixed mode)

  // Status tracking
  status         EnvelopeRecipientStatus @default(PENDING)
  sentAt         DateTime?
  viewedAt       DateTime?
  signedAt       DateTime?
  declinedAt     DateTime?
  declinedReason String?
  deliveredAt    DateTime? // Email delivery confirmation

  // Security
  signingToken String? @unique // Unique token for signing URL (no login required)
  accessCode   String? // Optional additional access code
  ipAddress    String? // IP when signed
  userAgent    String? // Browser info when signed
  geoLocation  Json? // { country, region, city, lat, lon } from IP

  // Signature data
  signatureImage String? // Base64 or URL to signature image
  initialsImage  String? // Base64 or URL to initials image

  // ESIGN/UETA compliance
  consentRecord     Json? // { timestamp, version, text, accepted }
  signatureChecksum Json? // { documentHash, signatureHash, token }

  // Reminder tracking
  lastReminderSentAt DateTime?
  reminderCount      Int @default(0)

  // Auto-contact creation
  contactId String? // Link to Contact if auto-created or matched

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([envelopeId, order])
  @@index([email, status])
  @@index([signingToken])
}

enum EnvelopeRecipientRole {
  SIGNER // Must sign the document
  CC // Carbon copy — receives completed copy, doesn't sign
  CERTIFIED_DELIVERY // Must acknowledge receipt
  IN_PERSON_SIGNER // Signs in person (host controls device)
}

enum EnvelopeRecipientStatus {
  PENDING // Not yet sent / waiting for prior signers
  SENT // Email sent, awaiting action
  DELIVERED // Email confirmed delivered
  VIEWED // Recipient opened the document
  SIGNED // Recipient completed signing
  DECLINED // Recipient declined to sign
  EXPIRED // Recipient's signing window expired
}

// Contact Vault — secure document vault for each Contact (1:1)
// Investors/contacts access via magic link. Auto-provisions when first document is filed.
model ContactVault {
  id        String @id @default(cuid())
  contactId String @unique // 1:1 with Contact
  teamId    String
  team      Team   @relation(fields: [teamId], references: [id], onDelete: Restrict)

  // Vault metadata
  totalDocuments Int    @default(0)
  totalSizeBytes BigInt @default(0)
  storageLimitBytes BigInt @default(52428800) // 50MB default (FREE tier)

  // Access configuration
  accessToken   String? @unique // Magic link token for vault access (no account required)
  accessExpiry  DateTime? // Token expiry
  lastAccessedAt DateTime?
  accessCount   Int @default(0)

  // Filing
  filings DocumentFiling[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([accessToken])
}

// Document Filing — tracks where documents are auto-filed after signing or other events.
// Creates an audit-grade record of every document copy in every vault.
model DocumentFiling {
  id String @id @default(cuid())

  // Source — what document was filed
  sourceType   DocumentFilingSourceType // SIGNED_DOCUMENT, NDA, ACCREDITATION, MANUAL_UPLOAD, SHARED
  sourceDocId  String? // Reference to the source document (SignatureDocument.id, LPDocument.id, etc.)
  envelopeId   String? // If filed from an Envelope completion
  envelope     Envelope? @relation(fields: [envelopeId], references: [id], onDelete: SetNull)

  // Destination — where the copy was filed
  destinationType DocumentFilingDestType // ORG_VAULT, CONTACT_VAULT, EMAIL
  orgVaultPath    String? // e.g., "/Signed Documents/2026-02/Agreement.pdf"
  contactVaultId  String? // Contact vault it was filed to
  contactVault    ContactVault? @relation(fields: [contactVaultId], references: [id], onDelete: SetNull)
  recipientEmail  String? // Email address if destination is EMAIL

  // Filed document reference
  filedFileUrl     String? // URL/key of the filed copy in storage
  filedStorageType DocumentStorageType?
  filedFileName    String?
  filedFileSize    BigInt?

  // Metadata
  teamId    String
  filedById String? // User who triggered the filing (null for auto-filing)
  filedAt   DateTime @default(now())
  metadata  Json? // Additional context (fund name, document type, etc.)

  // Audit
  auditHash String? // SHA-256 hash of the filed document for integrity verification

  createdAt DateTime @default(now())

  @@index([teamId, sourceType])
  @@index([contactVaultId])
  @@index([envelopeId])
  @@index([orgVaultPath])
}

enum DocumentFilingSourceType {
  SIGNED_DOCUMENT // Completed e-signature document
  NDA_AGREEMENT // Signed NDA from gate
  ACCREDITATION_RECORD // Accreditation acknowledgment
  MANUAL_UPLOAD // User uploaded directly to vault
  SHARED_DOCUMENT // Org shared a document with contact
  WIRE_PROOF // Wire transfer proof
  TAX_FORM // K-1, W-9, W-8BEN
  IDENTITY_DOCUMENT // Government ID, verification
}

enum DocumentFilingDestType {
  ORG_VAULT // Filed to org's document vault (folder structure)
  CONTACT_VAULT // Filed to contact's secure vault
  EMAIL // Emailed as attachment to recipient
}

// 6-digit verification code for free-tier dataroom access.
// Codes sent to approved email addresses only. 10-minute expiry, 3 max attempts.
model VerificationCode {
  id     String @id @default(cuid())
  email  String
  code   String // Hashed (SHA-256) 6-digit code
  linkId String? // Optional: which link/dataroom this code grants access to

  // Lifecycle
  expiresAt DateTime // 10-minute window
  attempts  Int @default(0) // Max 3 attempts before code is invalidated
  usedAt    DateTime? // When code was successfully verified

  // Security
  ipAddress String? // IP that requested the code
  userAgent String? // Browser info

  teamId String? // Optional team scoping

  createdAt DateTime @default(now())

  @@index([email, code])
  @@index([expiresAt])
  @@index([linkId])
}

